

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Calibrating the MATILDA framework &#8212; MATILDA</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Notebook4_MATILDA';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="MATILDA Scenarios" href="Notebook5_MATILDA_scenarios.html" />
    <link rel="prev" title="Climate scenario data" href="Notebook3_CMIP6.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="Notebook0_Introduction.html">
  
  
  
  
    
    
      
    
    
    <img src="https://www.hu-berlin.de/++resource++humboldt.logo.Logo.svg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="https://www.hu-berlin.de/++resource++humboldt.logo.Logo.svg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="Notebook0_Introduction.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Notebook1_Catchment_delineation.html">Catchment delineation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook2_Forcing_data.html">Climate forcing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook3_CMIP6.html">Climate scenario data</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Calibrating the MATILDA framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook5_MATILDA_scenarios.html">MATILDA Scenarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook6_Analysis.html">Model Output Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook7_Climate_Change_Impact.html">Climate Change Impact Analysis</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/phiscu/matilda_edu/main?urlpath=lab/tree/Notebook4_MATILDA.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/phiscu/matilda_edu" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/phiscu/matilda_edu/issues/new?title=Issue%20on%20page%20%2FNotebook4_MATILDA.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Notebook4_MATILDA.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Calibrating the MATILDA framework</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-matilda-with-default-parameters">Run MATILDA with default parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrate-matilda">Calibrate MATILDA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-glacier-mass-balance-data">Add glacier mass balance data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-matilda-with-calibrated-parameters">Run MATILDA with calibrated parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reducing-the-parameter-space-sensitivity-analysis-with-fast">Reducing the parameter space - Sensitivity analysis with FAST</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="calibrating-the-matilda-framework">
<h1>Calibrating the MATILDA framework<a class="headerlink" href="#calibrating-the-matilda-framework" title="Permalink to this heading">#</a></h1>
<p>In this notebook we will</p>
<ol class="arabic simple">
<li><p>… set up a glacio-hydrological model with all the data we have collected,</p></li>
<li><p>… run the model for the calibration period with default parameters and check the results,</p></li>
<li><p>… use a statistical parameter optimization routine to calibrate the model,</p></li>
<li><p>… and store the calibrated parameter set for the scenario runs in the next notebook.</p></li>
</ol>
<p>We will use the glacio-hydrological modeling library [MATILDA] (<a class="github reference external" href="https://github.com/cryotools/matilda">cryotools/matilda</a>), which has been developed for use in this workflow. It is based on the widely used <a class="reference external" href="https://www.cabdirect.org/cabdirect/abstract/19961904773">HBV hydrological model</a>, extended by a simple temperature-index melt model based roughly on the code of <a class="reference external" href="https://zenodo.org/record/3467639">Seguinot (2019)</a>. Glacier evolution over time is modeled using the Δ<em>h</em> approach following <a class="reference external" href="https://doi.org/10.5194/hess-22-2211-2018">Seibert et. al. (2018)</a>.</p>
<p>Let’s start by importing some helper functions to work with <code class="docutils literal notranslate"><span class="pre">yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">pickle</span></code> files and read required data from the config file.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tools.helpers</span> <span class="kn">import</span> <span class="n">update_yaml</span><span class="p">,</span> <span class="n">read_yaml</span><span class="p">,</span> <span class="n">write_yaml</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">ast</span>

<span class="c1"># read local config.ini file</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;config.ini&#39;</span><span class="p">)</span>

<span class="c1"># get output dir and date range from config.ini</span>
<span class="n">dir_input</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FILE_SETTINGS&#39;</span><span class="p">][</span><span class="s1">&#39;DIR_INPUT&#39;</span><span class="p">]</span>
<span class="n">dir_output</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FILE_SETTINGS&#39;</span><span class="p">][</span><span class="s1">&#39;DIR_OUTPUT&#39;</span><span class="p">]</span>
<span class="n">date_range</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;CONFIG&#39;</span><span class="p">][</span><span class="s1">&#39;DATE_RANGE&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MATILDA will be calibrated on the period &#39;</span> <span class="o">+</span> <span class="n">date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; to &#39;</span> <span class="o">+</span> <span class="n">date_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>The model requires a minimum setup period of one year. By default, the first two years are considered setup. We derive the respective dates from  the defined time period accordingly.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">length_of_setup_period</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">sim_start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span> <span class="o">=</span> <span class="n">length_of_setup_period</span><span class="p">)</span>
<span class="n">set_up_end</span> <span class="o">=</span> <span class="n">sim_start</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">dates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;set_up_start&#39;</span><span class="p">:</span> <span class="n">date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
         <span class="s1">&#39;set_up_end&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">set_up_end</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>        <span class="c1"># remove hh:mm:ss</span>
         <span class="s1">&#39;sim_start&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sim_start</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>          <span class="c1"># remove hh:mm:ss</span>
         <span class="s1">&#39;sim_end&#39;</span><span class="p">:</span> <span class="n">date_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">dates</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Many MATILDA parameters have been calculated in previous notebooks and stored in <code class="docutils literal notranslate"><span class="pre">settings.yaml</span></code>. We can easily add the modeling periods using a helper function. The calculated glacier profile from Notebook 1 can be imported as a <code class="docutils literal notranslate"><span class="pre">pandas</span> <span class="pre">DataFrame</span></code> and added to the settings dictionary as well.</p>
<p>Finally, we will also add some optional settings that control the aggregation frequency of the outputs, the choice of graphical outputs, and more.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">update_yaml</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;settings.yml&#39;</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>

<span class="n">remaining_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span>               <span class="c1"># aggregation level of model outputs (D, M, Y)</span>
                      <span class="s2">&quot;warn&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>             <span class="c1"># show warnings of subpackages?</span>
                      <span class="s2">&quot;plot_type&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>        <span class="c1"># interactive and/or non-interactive plots (&#39;print&#39;, &#39;interactive&#39;, &#39;all&#39;)</span>
                      <span class="s2">&quot;elev_rescaling&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>    <span class="c1"># treat mean glacier elevation as constant or change with glacier evolution</span>

<span class="n">update_yaml</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;settings.yml&#39;</span><span class="p">,</span> <span class="n">remaining_settings</span><span class="p">)</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">read_yaml</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;settings.yml&#39;</span><span class="p">)</span>
<span class="n">glacier_profile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;glacier_profile.csv&#39;</span><span class="p">)</span>
<span class="n">settings</span><span class="p">[</span><span class="s1">&#39;glacier_profile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glacier_profile</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MATILDA settings:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="run-matilda-with-default-parameters">
<h2>Run MATILDA with default parameters<a class="headerlink" href="#run-matilda-with-default-parameters" title="Permalink to this heading">#</a></h2>
<p>We will force MATILDA with the pre-processed ERA5-Land data from Notebook 2. Although MATILDA can run without calibration on observations, the results would have extreme uncertainties. Therefore, we recommend to use at least runoff observations for your selected point to evaluate the simulations against. Here, we load runoff observations for your example catchment from 1982 to 2020 (with gaps).</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">era5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;ERA5L.csv&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;prec&#39;</span><span class="p">])</span>
<span class="n">era5</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span> <span class="s1">&#39;T2&#39;</span><span class="p">,</span> <span class="s1">&#39;RRR&#39;</span><span class="p">]</span>

<span class="c1"># remove HH:MM:SS from &#39;TIMESTAMP&#39; column</span>
<span class="n">era5</span><span class="p">[</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">era5</span><span class="p">[</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">])</span>
<span class="n">era5</span><span class="p">[</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">era5</span><span class="p">[</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERA5 Data:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">era5</span><span class="p">)</span>

<span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_input</span> <span class="o">+</span> <span class="s1">&#39;obs_runoff_example.csv&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Observations:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>First, we run MATILDA with default parameters.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matilda.core</span> <span class="kn">import</span> <span class="n">matilda_simulation</span>

<span class="n">output_matilda</span> <span class="o">=</span> <span class="n">matilda_simulation</span><span class="p">(</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>The result is obviously far from reality and largely overestimates runoff. Therefore, the model needs calibration.</p>
</section>
<section id="calibrate-matilda">
<h2>Calibrate MATILDA<a class="headerlink" href="#calibrate-matilda" title="Permalink to this heading">#</a></h2>
<p>To adjust all model parameters to the catchment characteristics, we will perform an automated calibration using the <a class="reference external" href="https://doi.org/10.1371/journal.pone.0145180">Statistical Parameter Optimization Tool for Python</a>. Since large uncertainties in the input data (especially precipitation) can lead to an overestimation of melt when the model is calibrated to the hydrograph only, we will additionally include glacier mass balance data for a multi-objective calibration.</p>
<div class="alert alert-block alert-info">
<b>Note:</b> Statistical parameter optimization (SPOT) algorithms require a large number of model runs, especially for large parameter sets. Both <i>mybinder.org</i> and <i>Google Colab</i> offer a maximum of two cores per user. One MATILDA run for 20 years takes roughly 3s on one core. Therefore, large optimization runs in an online environment will be slow and may require you to leave the respective browser tab in the foreground for hours. To speed things up, you can either...</div>
<p>… run this notebook locally on a computer with more cores (ideally a high performance cluster) or …</p>
<p>… reduce the number of calibration parameters using the global sensitivity. We will return to this topic later in this notebook.</p>
<p>Here we will demonstrate the use of the SPOT functions and then continue with a parameter set from a large HPC optimization run. If you need assistance to implement the routine on your HPC consult the <a class="reference external" href="https://spotpy.readthedocs.io/en/latest/Advanced_hints/#mpi-parallel-computing">SPOTPY documentation</a> and contact us if you run into problems.</p>
<section id="add-glacier-mass-balance-data">
<h3>Add glacier mass balance data<a class="headerlink" href="#add-glacier-mass-balance-data" title="Permalink to this heading">#</a></h3>
<p>In addition to runoff we will use glacier mass balance as second calibration variable. <a class="reference external" href="https://doi.org/10.3389/feart.2019.00363">Shean et. al. 2020 </a> calculated robust geodetic mass balances for all glaciers in High Mountain Asia from 2000 to 2018. For this example (and all other catchments in HMA), we can use their data set so derive a target average annual mass balance in the calibration period. If your catchment is located outside HMA, you need to consult other sources.</p>
<p>We pick all individual mass balances that match the glacier IDs in our catchment and calculate the mean. In addition, we use the uncertainty measures listed in the dataset to derive an uncertainty range.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">mass_balances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_input</span> <span class="o">+</span> <span class="s1">&#39;/hma_mb_20190215_0815_rmse.csv&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RGIId&#39;</span><span class="p">,</span> <span class="s1">&#39;mb_mwea&#39;</span><span class="p">,</span> <span class="s1">&#39;mb_mwea_sigma&#39;</span><span class="p">])</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;/RGI/Glaciers_in_catchment.csv&#39;</span><span class="p">)</span>

<span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mass_balances</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;RGIId&#39;</span><span class="p">)</span>
<span class="n">mean_mb</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;mb_mwea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>   <span class="c1"># Mean catchment MB in mm w.e.</span>
<span class="n">mean_sigma</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;mb_mwea_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_mb</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Mean uncertainty of catchment MB in mm w.e.</span>

<span class="n">target_mb</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_mb</span> <span class="o">-</span> <span class="n">mean_sigma</span><span class="p">,</span> <span class="n">mean_mb</span> <span class="o">+</span> <span class="n">mean_sigma</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Target glacier mass balance for calibration: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mean_mb</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; +-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mean_sigma</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;mm w.e.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>The MATILDA framework provides an interface to <a class="reference external" href="https://github.com/thouska/spotpy/">SPOTPY</a>. Here we will use the <code class="docutils literal notranslate"><span class="pre">psample()</span></code> function to run MATILDA with the same settings as before. To do this, we will remove redundant <code class="docutils literal notranslate"><span class="pre">settings</span></code> and add some new ones specific to the function. Be sure to choose the number of repetitions carefully.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tools.helpers</span> <span class="kn">import</span> <span class="n">drop_keys</span>

<span class="n">psample_settings</span> <span class="o">=</span> <span class="n">drop_keys</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="s1">&#39;plots&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_type&#39;</span><span class="p">])</span>

<span class="n">additional_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rep&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>                            <span class="c1"># Number of model runs. For advice check the documentation of the algorithms.</span>
                       <span class="s1">&#39;glacier_only&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>                 <span class="c1"># True when calibrating a entirely glacierized catchment</span>
                       <span class="s1">&#39;obj_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;maximize&#39;</span><span class="p">,</span>                 <span class="c1"># should your objective funtion be maximized (e.g. NSE) or minimized (e.g. RMSE)</span>
                       <span class="s1">&#39;target_mb&#39;</span><span class="p">:</span> <span class="n">mean_mb</span><span class="p">,</span>                     <span class="c1"># Average annual glacier mass balance to target at</span>
                       <span class="s1">&#39;dbformat&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                      <span class="c1"># Write the results to a file (&#39;csv&#39;, &#39;hdf5&#39;, &#39;ram&#39;, &#39;sql&#39;)</span>
                       <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                        <span class="c1"># Choose where to store the files</span>
                       <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;lhs&#39;</span><span class="p">,</span>                    <span class="c1"># Choose algorithm (for parallelization: mc, lhs, fast, rope, sceua or demcz)</span>
                       <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="s1">&#39;era5_matilda_example&#39;</span><span class="p">,</span>      <span class="c1"># Choose name</span>
                       
                       <span class="s1">&#39;parallel&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>                     <span class="c1"># Distribute the calculation on multiple cores or not</span>
                      <span class="c1"># &#39;cores&#39;: 20                           # Set number of cores when running parallel</span>
                      <span class="p">}</span>
<span class="n">psample_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">additional_settings</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Settings for calibration runs:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">psample_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">psample_settings</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>With these settings we can start the <code class="docutils literal notranslate"><span class="pre">psample()</span></code> to run our model with various parameter combinations. The default parameter boundaries can be found in the MATILDA <a class="reference external" href="https://github.com/cryotools/matilda/blob/master/Parameters">parameter documentation</a>. If you want to narrow down the parameter space you can do that using the following syntax. Here, we define custom ranges for the temperature lapse rate and the precipitation correction factor.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matilda.mspot_glacier</span> <span class="kn">import</span> <span class="n">psample</span>

<span class="n">lim_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lr_temp_lo&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.007</span><span class="p">,</span> <span class="s1">&#39;lr_temp_up&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="s1">&#39;PCORR_lo&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;PCORR_up&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">}</span>

<span class="n">best_summary</span> <span class="o">=</span> <span class="n">psample</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">psample_settings</span><span class="p">,</span> <span class="o">**</span><span class="n">lim_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="run-matilda-with-calibrated-parameters">
<h2>Run MATILDA with calibrated parameters<a class="headerlink" href="#run-matilda-with-calibrated-parameters" title="Permalink to this heading">#</a></h2>
<p>The following parameter set was computed using an updated version of the Differential Evolution Markov Chain (DE-MCz) algorithm with 55k iterations on an HPC cluster. The parameters were optimized for runoff using the <a class="reference external" href="https://doi.org/10.1016/j.jhydrol.2012.01.011">Kling-Gupta model efficiency coefficient</a> and the results were filtered to match the target mass balance range.
<a id="param"></a></p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lr_temp&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.006472598</span><span class="p">,</span>
         <span class="s1">&#39;lr_prec&#39;</span><span class="p">:</span> <span class="mf">0.00010296448</span><span class="p">,</span>
         <span class="s1">&#39;BETA&#39;</span><span class="p">:</span> <span class="mf">4.625306</span><span class="p">,</span>
         <span class="s1">&#39;CET&#39;</span><span class="p">:</span> <span class="mf">0.2875196</span><span class="p">,</span>
         <span class="s1">&#39;FC&#39;</span><span class="p">:</span> <span class="mf">364.81818</span><span class="p">,</span>
         <span class="s1">&#39;K0&#39;</span><span class="p">:</span> <span class="mf">0.28723368</span><span class="p">,</span>
         <span class="s1">&#39;K1&#39;</span><span class="p">:</span> <span class="mf">0.015692418</span><span class="p">,</span>
         <span class="s1">&#39;K2&#39;</span><span class="p">:</span> <span class="mf">0.004580627</span><span class="p">,</span>
         <span class="s1">&#39;LP&#39;</span><span class="p">:</span> <span class="mf">0.587188</span><span class="p">,</span>
         <span class="s1">&#39;MAXBAS&#39;</span><span class="p">:</span> <span class="mf">6.730105</span><span class="p">,</span>
         <span class="s1">&#39;PERC&#39;</span><span class="p">:</span> <span class="mf">1.1140852</span><span class="p">,</span>
         <span class="s1">&#39;UZL&#39;</span><span class="p">:</span> <span class="mf">198.82584</span><span class="p">,</span>
         <span class="s1">&#39;PCORR&#39;</span><span class="p">:</span> <span class="mf">0.74768984</span><span class="p">,</span>
         <span class="s1">&#39;TT_snow&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.3534238</span><span class="p">,</span>
         <span class="s1">&#39;TT_diff&#39;</span><span class="p">:</span> <span class="mf">0.70977557</span><span class="p">,</span>
         <span class="s1">&#39;CFMAX_ice&#39;</span><span class="p">:</span> <span class="mf">2.782649</span><span class="p">,</span>
         <span class="s1">&#39;CFMAX_rel&#39;</span><span class="p">:</span> <span class="mf">1.2481626</span><span class="p">,</span>
         <span class="s1">&#39;SFCF&#39;</span><span class="p">:</span> <span class="mf">0.879982</span><span class="p">,</span>
         <span class="s1">&#39;CWH&#39;</span><span class="p">:</span> <span class="mf">0.0020890352</span><span class="p">,</span>
         <span class="s1">&#39;AG&#39;</span><span class="p">:</span> <span class="mf">0.8640329</span><span class="p">,</span>
         <span class="s1">&#39;RFS&#39;</span><span class="p">:</span> <span class="mf">0.21825151</span><span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calibrated parameter set:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_matilda</span> <span class="o">=</span> <span class="n">matilda_simulation</span><span class="p">(</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">,</span> <span class="n">parameter_set</span><span class="o">=</span><span class="n">param</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>In addition to the standard plots we can explore the results interactive <code class="docutils literal notranslate"><span class="pre">ploty</span></code> plots. Go ahead and zoom as you like or select/deselect individual curves.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_matilda</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>The same works for the long-term seasonal cycle.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_matilda</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="reducing-the-parameter-space-sensitivity-analysis-with-fast">
<h2>Reducing the parameter space - Sensitivity analysis with FAST<a class="headerlink" href="#reducing-the-parameter-space-sensitivity-analysis-with-fast" title="Permalink to this heading">#</a></h2>
<p>To reduce the computation time of the calibration procedure, we need to reduce the number of parameters to be optimized. Therefore, we will perform a global sensitivity analysis to identify the most important parameters and set the others to default values. The algorithm of choice will be the <a class="reference external" href="https://www.tandfonline.com/doi/abs/10.1080/00401706.1999.10485594">Fourier Amplitude Sensitivity Test (FAST)</a> available through the <a class="reference external" href="https://github.com/thouska/spotpy/blob/master/src/spotpy/algorithms/fast.py">SPOTPY</a> library. As before, we will show the general procedure with a few iterations, but display results from extensive runs on a HPC. You can use the results as a guide for your parameter choices, but keep in mind that they are highly correlated with your catchment properties, such as elevation range and glacier coverage.</p>
<p>First, we calculate the required number of iterations using a formula from <a class="reference external" href="https://www.informs-sim.org/wsc12papers/includes/files/con308.pdf">Henkel et. al. 2012</a>. We choose the SPOTPY default frequency step of 2 and set the interference factor to a maximum of 4, since we assume a high intercorrelation of the model parameters. The total number of parameters in MATILDA is 21.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fast_iter</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">interf</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">freqst</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the number of parameter iterations needed for parameterization and sensitivity analysis using FAST.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : int</span>
<span class="sd">        The number of input parameters being analyzed.</span>
<span class="sd">    interf : int</span>
<span class="sd">        The interference factor, which determines the degree of correlation between the input parameters.</span>
<span class="sd">    freqst : int</span>
<span class="sd">        The frequency step, which specifies the size of the intervals between each frequency at which the Fourier transform is calculated.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        The total number of parameter iterations needed for FAST.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">interf</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">param</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">freqst</span><span class="p">))</span> <span class="o">*</span> <span class="n">param</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Needed number of iterations for FAST: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fast_iter</span><span class="p">(</span><span class="mi">21</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>That is a lot of iterations! Running this routine on a single core would take about two days, but can be sped up significantly with each additional core. The setup would look exactly like the parameter optimization before.</p>
<p><strong>Note:</strong> No matter what number of iterations you define, SPOTPY will run <span class="math notranslate nohighlight">\(N*k\)</span> times, where <span class="math notranslate nohighlight">\(k\)</span> is the number of model parameters. So even if we set <code class="docutils literal notranslate"><span class="pre">rep=10</span></code>, the algorithm will run at least 21 times.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matilda.mspot_glacier</span> <span class="kn">import</span> <span class="n">psample</span>

<span class="n">fast_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rep&#39;</span><span class="p">:</span> <span class="mi">52437</span><span class="p">,</span>                              <span class="c1"># Choose wisely before running</span>
                 <span class="s1">&#39;target_mb&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;fast&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="s1">&#39;fast_matilda_example&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;fast_example&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;dbformat&#39;</span><span class="p">:</span> <span class="s1">&#39;csv&#39;</span>
                      <span class="p">}</span>
<span class="n">psample_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fast_settings</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Settings for FAST:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">psample_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">psample_settings</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

<span class="c1"># fast_results = psample(df=era5, obs=obs, **psample_settings)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>We ran <em>FAST</em>s for the example catchment with the full number of iterations required. The results are saved in <em>CSV</em> files. We can use the <code class="docutils literal notranslate"><span class="pre">spotpy.analyser</span></code> library to create easy-to-read data frames from the databases. The summary shows the first (<code class="docutils literal notranslate"><span class="pre">S1</span></code>) and the total order sensitivity index (<code class="docutils literal notranslate"><span class="pre">ST</span></code>) for each parameter. <code class="docutils literal notranslate"><span class="pre">S1</span></code> refers to the variance of the model output explained by the parameter, holding all other parameters constant. The <code class="docutils literal notranslate"><span class="pre">ST</span></code> takes into account the interaction of the parameters and is therefore a good measure of the impact of individual parameters on the model output.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">spotpy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">contextlib</span>

<span class="k">def</span> <span class="nf">get_si</span><span class="p">(</span><span class="n">fast_results</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_csv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the sensitivity indices of a given FAST simulation results file.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fast_results : str</span>
<span class="sd">        The path of the FAST simulation results file.</span>
<span class="sd">    to_csv : bool, optional</span>
<span class="sd">        If True, the sensitivity indices are saved to a CSV file with the same</span>
<span class="sd">        name as fast_results, but with &#39;_sensitivity_indices.csv&#39; appended to</span>
<span class="sd">        the end (default is False).</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        A pandas DataFrame containing the sensitivity indices and parameter</span>
<span class="sd">        names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fast_results</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
        <span class="n">fast_results</span> <span class="o">=</span> <span class="n">fast_results</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># strip .csv</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">spotpy</span><span class="o">.</span><span class="n">analyser</span><span class="o">.</span><span class="n">load_csv_results</span><span class="p">(</span><span class="n">fast_results</span><span class="p">)</span>
    <span class="c1"># Suppress prints</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)):</span>
        <span class="n">SI</span> <span class="o">=</span> <span class="n">spotpy</span><span class="o">.</span><span class="n">analyser</span><span class="o">.</span><span class="n">get_sensitivity_of_fast</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">print_to_console</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parnames</span> <span class="o">=</span> <span class="n">spotpy</span><span class="o">.</span><span class="n">analyser</span><span class="o">.</span><span class="n">get_parameternames</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">sens</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">SI</span><span class="p">)</span>
    <span class="n">sens</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parnames</span>
    <span class="n">sens</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">to_csv</span><span class="p">:</span>
        <span class="n">sens</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fast_results</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_sensitivity_indices.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sens</span>

<span class="n">display</span><span class="p">(</span><span class="n">get_si</span><span class="p">(</span><span class="n">dir_input</span> <span class="o">+</span> <span class="s1">&#39;FAST/&#39;</span> <span class="o">+</span> <span class="s1">&#39;example_fast_nolim.csv&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>If you have additional information on certain parameters, limiting their bounds can have a large impact on sensitivity. For our example catchment, field observations showed that the temperature lapse rate and precipitation correction were unlikely to exceed a certain range, so we limited the parameter space for both and ran a <em>FAST</em> again.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lim_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lr_temp_lo&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.007</span><span class="p">,</span> <span class="s1">&#39;lr_temp_up&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="s1">&#39;PCORR_lo&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;PCORR_up&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">}</span>
<span class="c1"># fast_results = psample(df=era5, obs=obs, **psample_settings, **lim_dict)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>To see the effect of parameter restrictions on sensitivity, we can plot the indices of both runs. Feel free to explore further by adding more <em>FAST</em> outputs to the plot function.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly.io</span> <span class="k">as</span> <span class="nn">pio</span>

<span class="k">def</span> <span class="nf">plot_sensitivity_bars</span><span class="p">(</span><span class="o">*</span><span class="n">dfs</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bar_width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">bar_gap</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots a horizontal bar chart showing the total sensitivity index for each parameter in a MATILDA model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *dfs : pandas.DataFrame</span>
<span class="sd">        Multiple dataframes containing the sensitivity indices for each parameter.</span>
<span class="sd">    labels : list of str, optional</span>
<span class="sd">        Labels to use for the different steps in the sensitivity analysis. If not provided, the default</span>
<span class="sd">        labels will be &#39;No Limits&#39;, &#39;Step 1&#39;, &#39;Step 2&#39;, etc.</span>
<span class="sd">    bar_width : float, optional</span>
<span class="sd">        Width of each bar in the chart.</span>
<span class="sd">    bar_gap : float, optional</span>
<span class="sd">        Space between bars.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;cyan&#39;</span><span class="p">]</span>   <span class="c1"># add more colors if needed</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">get_si</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Step &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;No Limits&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                       <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ST&#39;</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                       <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
                       <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                       <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">)</span>
        <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;&lt;b&gt;&#39;</span> <span class="o">+</span><span class="s1">&#39;Total Sensitivity Index for MATILDA Parameters&#39;</span> <span class="o">+</span> <span class="s1">&#39;&lt;b&gt;&#39;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">)),</span>
                   <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Total Sensitivity Index&#39;</span><span class="p">,</span>
                   <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Parameter&#39;</span><span class="p">,</span>
                   <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                   <span class="n">bargap</span><span class="o">=</span><span class="n">bar_gap</span><span class="p">,</span>
                   <span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">traces</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
<span class="n">step1</span> <span class="o">=</span> <span class="n">dir_input</span> <span class="o">+</span> <span class="s1">&#39;FAST/&#39;</span> <span class="o">+</span> <span class="s1">&#39;example_fast_nolim.csv&#39;</span>
<span class="n">step2</span> <span class="o">=</span> <span class="n">dir_input</span> <span class="o">+</span> <span class="s1">&#39;FAST/&#39;</span> <span class="o">+</span> <span class="s1">&#39;era5_ipynb_fast_step1.csv&#39;</span>

<span class="n">plot_sensitivity_bars</span><span class="p">(</span><span class="n">step1</span><span class="p">,</span> <span class="n">step2</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Limits&#39;</span><span class="p">,</span> <span class="s1">&#39;lr_temp and PCORR limited&#39;</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>From this figure, we can easily identify the most important parameters. Depending on your desired accuracy and computational resources, you can choose a sensitivity threshold. Let’s say we want to fix all parameters with a sensitivity index below 0.1. For our example, this will reduce the calibration parameters to 7.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">si_df</span> <span class="o">=</span> <span class="n">get_si</span><span class="p">(</span><span class="n">step2</span><span class="p">)</span>
<span class="n">sensitive</span> <span class="o">=</span> <span class="n">si_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">si_df</span><span class="p">[</span><span class="s1">&#39;ST&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.10</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parameters with a sensitivity index &gt; 0.1:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sensitive</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>To give you an idea how much this procedure can reduce calibration time, we run the <code class="docutils literal notranslate"><span class="pre">fast_iter()</span></code> function again.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Needed number of iterations for FAST with all parameters: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fast_iter</span><span class="p">(</span><span class="mi">21</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Needed number of iterations for FAST with the 7 most sensitive parameters: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fast_iter</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>For a single core this would roughly translate into a reduction from 44h to 4h.</p>
<p>To run the calibration with the reduced parameter space, we simply need to define values for the fixed parameters and use a helper function to translate them into boundary arguments. Here we simply use the values from our last <em>SPOTPY</em> run (<code class="docutils literal notranslate"><span class="pre">param</span></code>).</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matilda.mspot_glacier</span> <span class="kn">import</span> <span class="n">dict2bounds</span>

<span class="n">fixed_param</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sensitive</span><span class="p">}</span>
<span class="n">fixed_param_bounds</span> <span class="o">=</span> <span class="n">dict2bounds</span><span class="p">(</span><span class="n">fixed_param</span><span class="p">)</span>
       
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fixed bounds:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fixed_param_bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fixed_param_bounds</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">psample()</span></code> setup is then as simple as before.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rep&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>                             <span class="c1"># Number of model runs. For advice check the documentation of the algorithms.</span>
                <span class="s1">&#39;glacier_only&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>                 <span class="c1"># True when calibrating a entirely glacierized catchment</span>
                <span class="s1">&#39;obj_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;maximize&#39;</span><span class="p">,</span>                 <span class="c1"># should your objective funtion be maximized (e.g. NSE) or minimized (e.g. RMSE)</span>
                <span class="s1">&#39;target_mb&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">156</span><span class="p">,</span>                     <span class="c1"># Average annual glacier mass balance to target at</span>
                <span class="s1">&#39;dbformat&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                      <span class="c1"># Write the results to a file (&#39;csv&#39;, &#39;hdf5&#39;, &#39;ram&#39;, &#39;sql&#39;)</span>
                <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                        <span class="c1"># Choose where to store the files</span>
                <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;lhs&#39;</span><span class="p">,</span>                    <span class="c1"># Choose algorithm (for parallelization: mc, lhs, fast, rope, sceua or demcz)</span>
                <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="s1">&#39;era5_matilda_example&#39;</span><span class="p">,</span>      <span class="c1"># Choose name</span>
                       
                <span class="s1">&#39;parallel&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>                     <span class="c1"># Distribute the calculation on multiple cores or not</span>
                <span class="c1"># &#39;cores&#39;: 20                           # Set number of cores when running parallel</span>
                      <span class="p">}</span>
<span class="n">psample_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_settings</span><span class="p">)</span>

<span class="n">best_summary</span> <span class="o">=</span> <span class="n">psample</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">psample_settings</span><span class="p">,</span> <span class="o">**</span><span class="n">fixed_param_bounds</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="alert alert-block alert-info">
<b>Note:</b> The number of iterations required depends on the selected algorithm and the number of free parameters. To choose the correct setting, consult the <a href='https://spotpy.readthedocs.io/en/latest/Algorithm_guide/'>SPOTPY documentation</a> and the original literature for each algorithm.</div><p>Now, we save the best parameter set for use in the next notebook. The set is stored in the <code class="docutils literal notranslate"><span class="pre">best_summary</span></code> variable.</p>
<p><strong>Note:</strong> In our example we will skip this step and use the <span class="xref myst">result from the calibration on an HPC cluster</span>.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># param = best_summary[&#39;best_param&#39;]</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Finally, we store the parameter set in a <code class="docutils literal notranslate"><span class="pre">.yml</span></code> file.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">write_yaml</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;parameters.yml&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter set stored in &#39;</span><span class="si">{</span><span class="n">dir_output</span><span class="si">}</span><span class="s2">parameters.yml&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="Notebook3_CMIP6.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Climate scenario data</p>
      </div>
    </a>
    <a class="right-next"
       href="Notebook5_MATILDA_scenarios.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">MATILDA Scenarios</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-matilda-with-default-parameters">Run MATILDA with default parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrate-matilda">Calibrate MATILDA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-glacier-mass-balance-data">Add glacier mass balance data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-matilda-with-calibrated-parameters">Run MATILDA with calibrated parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reducing-the-parameter-space-sensitivity-analysis-with-fast">Reducing the parameter space - Sensitivity analysis with FAST</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Phillip Schuster
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>