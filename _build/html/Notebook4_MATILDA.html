
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Calibrating the MATILDA framework &#8212; MATILDA</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Notebook4_MATILDA';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="MATILDA Scenarios" href="Notebook5_MATILDA_scenarios.html" />
    <link rel="prev" title="Climate scenario data" href="Notebook3_CMIP6.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="Notebook0_Introduction.html">
  
  
  
  
  
    
    
      
    
    
    <img src="https://www.hu-berlin.de/++resource++humboldt.logo.Logo.svg" class="logo__image only-light" alt="MATILDA - Home"/>
    <script>document.write(`<img src="https://www.hu-berlin.de/++resource++humboldt.logo.Logo.svg" class="logo__image only-dark" alt="MATILDA - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="Notebook0_Introduction.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Notebook1_Catchment_delineation.html">Catchment delineation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook2_Forcing_data.html">Climate forcing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook3_CMIP6.html">Climate scenario data</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Calibrating the MATILDA framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook5_MATILDA_scenarios.html">MATILDA Scenarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook6_Analysis.html">Model Output Analysis and Climate Change Impact Analysis</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/phiscu/matilda_edu/main?urlpath=lab/tree/Notebook4_MATILDA.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/phiscu/matilda_edu" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/phiscu/matilda_edu/issues/new?title=Issue%20on%20page%20%2FNotebook4_MATILDA.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Notebook4_MATILDA.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Calibrating the MATILDA framework</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-matilda-with-default-parameters">Run MATILDA with default parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrate-matilda">Calibrate MATILDA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#glacier-surface-mass-balance-data">Glacier surface mass balance data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#snow-water-equivalent">Snow water equivalent</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-based-calibration">Process-based calibration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-input-correction">Step 1: Input correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-snow-routine-calibration">Step 2: Snow routine calibration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-glacier-routine-calibration">Step 3: Glacier routine calibration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-soil-and-routing-routine-calibration">Step 4: Soil and routing routine calibration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-matilda-with-calibrated-parameters">Run MATILDA with calibrated parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sensitivity-analysis-with-fast">Sensitivity Analysis with FAST</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="calibrating-the-matilda-framework">
<h1>Calibrating the MATILDA framework<a class="headerlink" href="#calibrating-the-matilda-framework" title="Link to this heading">#</a></h1>
<p>While the last notebooks focused on data acquisition and preprocessing, we can finally start modeling. In this notebook we will…</p>
<ol class="arabic simple">
<li><p>… set up a glacio-hydrological model with all the data we have collected,</p></li>
<li><p>… run the model for the calibration period with default parameters and check the results,</p></li>
<li><p>… use a statistical parameter optimization routine to calibrate the model,</p></li>
<li><p>… and store the calibrated parameter set for the scenario runs in the next notebook.</p></li>
</ol>
<p>The framework for Modeling water resources in glacierized catchments [MATILDA] (<a class="github reference external" href="https://github.com/cryotools/matilda">cryotools/matilda</a>) has been developed for use in this workflow and is published as a Python package. It is based on the widely used <a class="reference external" href="https://www.cabdirect.org/cabdirect/abstract/19961904773">HBV hydrological model</a>, complemented by a temperature-index glacier melt model based on the code of <a class="reference external" href="https://zenodo.org/record/3467639">Seguinot (2019)</a>. Glacier evolution over time is simulated using a modified version of the Δ<em>h</em> approach following <a class="reference external" href="https://doi.org/10.5194/hess-22-2211-2018">Seibert et. al. (2018)</a>.</p>
<p>As before we start by loading configurations such as the calibration period and some helper functions to work with  <code class="docutils literal notranslate"><span class="pre">yaml</span></code> files.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tools.helpers</span> <span class="kn">import</span> <span class="n">update_yaml</span><span class="p">,</span> <span class="n">read_yaml</span><span class="p">,</span> <span class="n">write_yaml</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">ast</span>

<span class="c1"># read local config.ini file</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;config.ini&#39;</span><span class="p">)</span>

<span class="c1"># get output dir and date range from config.ini</span>
<span class="n">dir_input</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FILE_SETTINGS&#39;</span><span class="p">][</span><span class="s1">&#39;DIR_INPUT&#39;</span><span class="p">]</span>
<span class="n">dir_output</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FILE_SETTINGS&#39;</span><span class="p">][</span><span class="s1">&#39;DIR_OUTPUT&#39;</span><span class="p">]</span>
<span class="n">date_range</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;CONFIG&#39;</span><span class="p">][</span><span class="s1">&#39;CALIBRATION_PERIOD&#39;</span><span class="p">])</span>
<span class="n">zip_output</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;CONFIG&#39;</span><span class="p">][</span><span class="s1">&#39;ZIP_OUTPUT&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MATILDA will be calibrated on the period &#39;</span> <span class="o">+</span> <span class="n">date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; to &#39;</span> <span class="o">+</span> <span class="n">date_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MATILDA will be calibrated on the period 1998-01-01 to 2020-12-31
</pre></div>
</div>
</div>
</div>
<p>Since HBV is a so-called ‘bucket’ model and all the buckets are empty in the first place we need to fill them in a setup period of minimum one year. If not specified, the first two years of the <code class="docutils literal notranslate"><span class="pre">DATE_RANGE</span></code> in the <code class="docutils literal notranslate"><span class="pre">config</span></code> are used for set up.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">length_of_setup_period</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">sim_start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span> <span class="o">=</span> <span class="n">length_of_setup_period</span><span class="p">)</span>
<span class="n">set_up_end</span> <span class="o">=</span> <span class="n">sim_start</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">dates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;set_up_start&#39;</span><span class="p">:</span> <span class="n">date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
         <span class="s1">&#39;set_up_end&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">set_up_end</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>        <span class="c1"># remove hh:mm:ss</span>
         <span class="s1">&#39;sim_start&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sim_start</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>          <span class="c1"># remove hh:mm:ss</span>
         <span class="s1">&#39;sim_end&#39;</span><span class="p">:</span> <span class="n">date_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">dates</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>set_up_start: 1998-01-01
set_up_end: 1999-12-31
sim_start: 2000-01-01
sim_end: 2020-12-31
</pre></div>
</div>
</div>
</div>
<p>Many MATILDA parameters have been calculated in previous notebooks and stored in <code class="docutils literal notranslate"><span class="pre">settings.yaml</span></code>. We can easily add the modeling periods using a helper function. The calculated glacier profile from Notebook 1 can be imported as a <code class="docutils literal notranslate"><span class="pre">pandas</span> <span class="pre">DataFrame</span></code> and added to the <code class="docutils literal notranslate"><span class="pre">settings</span></code> dictionary as well.</p>
<p>Finally, we will also add some optional settings that control the aggregation frequency of the outputs, the choice of graphical outputs, and more.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">update_yaml</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;settings.yml&#39;</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>

<span class="n">remaining_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span>               <span class="c1"># aggregation frequency of model outputs (D, M, Y)</span>
                      <span class="s2">&quot;warn&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>             <span class="c1"># show warnings of subpackages?</span>
                      <span class="s2">&quot;plot_type&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>        <span class="c1"># interactive and/or non-interactive plots (&#39;print&#39;, &#39;interactive&#39;, &#39;all&#39;)</span>
                      <span class="s2">&quot;elev_rescaling&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>    <span class="c1"># treat mean glacier elevation as constant or change with glacier evolution</span>

<span class="n">update_yaml</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;settings.yml&#39;</span><span class="p">,</span> <span class="n">remaining_settings</span><span class="p">)</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">read_yaml</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;settings.yml&#39;</span><span class="p">)</span>
<span class="n">glacier_profile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;glacier_profile.csv&#39;</span><span class="p">)</span>
<span class="n">settings</span><span class="p">[</span><span class="s1">&#39;glacier_profile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glacier_profile</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MATILDA settings:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data successfully written to YAML at output/settings.yml
Data successfully written to YAML at output/settings.yml
MATILDA settings:


area_cat: 300.6637184185051
area_glac: 31.829413146586116
ele_cat: 3271.895648388366
ele_dat: 3324.5555520312164
ele_glac: 4001.8798828125
elev_rescaling: True
freq: M
lat: 42.18511742495568
plot_type: all
set_up_end: 1999-12-31
set_up_start: 1998-01-01
sim_end: 2020-12-31
sim_start: 2000-01-01
warn: False
glacier_profile:      Elevation      Area          WE  EleZone
0         1970  0.000000      0.0000     1900
1         2000  0.000000      0.0000     2000
2         2100  0.000000      0.0000     2100
3         2200  0.000000      0.0000     2200
4         2300  0.000000      0.0000     2300
..         ...       ...         ...      ...
156       4730  0.000023  20721.3700     4700
157       4740  0.000012  14450.2180     4700
158       4750  0.000006  10551.4730     4700
159       4760  0.000000      0.0000     4700
160       4780  0.000002   6084.7456     4700

[161 rows x 4 columns]
</pre></div>
</div>
</div>
</div>
<section id="run-matilda-with-default-parameters">
<h2>Run MATILDA with default parameters<a class="headerlink" href="#run-matilda-with-default-parameters" title="Link to this heading">#</a></h2>
<p>We will force MATILDA with the pre-processed ERA5-Land data from Notebook 2. Although MATILDA can run without calibration on observations, the results would have extreme uncertainties. Therefore, we recommend to use at least discharge observations for your selected point to evaluate the simulations against. Here, we load discharge observations for your example catchment. As you can see, we have meteorological forcing data since 1979 and discharge data since 1982. However, most of the glacier datasets used start in 2000/2001 and glaciers are a significant part of the water balance. In its current version, MATILDA is not able to extrapolate glacier cover, so we will only calibrate the model using data from 2000 onwards.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">era5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;ERA5L.csv&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;prec&#39;</span><span class="p">])</span>
<span class="n">era5</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span> <span class="s1">&#39;T2&#39;</span><span class="p">,</span> <span class="s1">&#39;RRR&#39;</span><span class="p">]</span>

<span class="c1"># remove HH:MM:SS from &#39;TIMESTAMP&#39; column</span>
<span class="n">era5</span><span class="p">[</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">era5</span><span class="p">[</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">])</span>
<span class="n">era5</span><span class="p">[</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">era5</span><span class="p">[</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERA5 Data:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">era5</span><span class="p">)</span>

<span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_input</span> <span class="o">+</span> <span class="s1">&#39;obs_runoff_example.csv&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Observations:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ERA5 Data:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TIMESTAMP</th>
      <th>T2</th>
      <th>RRR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1979-01-01</td>
      <td>257.460053</td>
      <td>0.027150</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1979-01-02</td>
      <td>256.509735</td>
      <td>0.004800</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1979-01-03</td>
      <td>257.944142</td>
      <td>0.001599</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1979-01-04</td>
      <td>258.392049</td>
      <td>0.281500</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1979-01-05</td>
      <td>258.125576</td>
      <td>0.107802</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>16797</th>
      <td>2024-12-27</td>
      <td>263.179270</td>
      <td>0.026296</td>
    </tr>
    <tr>
      <th>16798</th>
      <td>2024-12-28</td>
      <td>259.782440</td>
      <td>0.000917</td>
    </tr>
    <tr>
      <th>16799</th>
      <td>2024-12-29</td>
      <td>261.269940</td>
      <td>0.005262</td>
    </tr>
    <tr>
      <th>16800</th>
      <td>2024-12-30</td>
      <td>263.580786</td>
      <td>1.161816</td>
    </tr>
    <tr>
      <th>16801</th>
      <td>2024-12-31</td>
      <td>259.719079</td>
      <td>1.057546</td>
    </tr>
  </tbody>
</table>
<p>16802 rows × 3 columns</p>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Observations:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Qobs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>01/01/1982</td>
      <td>1.31</td>
    </tr>
    <tr>
      <th>1</th>
      <td>01/02/1982</td>
      <td>1.19</td>
    </tr>
    <tr>
      <th>2</th>
      <td>01/03/1982</td>
      <td>1.31</td>
    </tr>
    <tr>
      <th>3</th>
      <td>01/04/1982</td>
      <td>1.31</td>
    </tr>
    <tr>
      <th>4</th>
      <td>01/05/1982</td>
      <td>1.19</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>14240</th>
      <td>12/27/2020</td>
      <td>3.25</td>
    </tr>
    <tr>
      <th>14241</th>
      <td>12/28/2020</td>
      <td>3.23</td>
    </tr>
    <tr>
      <th>14242</th>
      <td>12/29/2020</td>
      <td>3.08</td>
    </tr>
    <tr>
      <th>14243</th>
      <td>12/30/2020</td>
      <td>2.93</td>
    </tr>
    <tr>
      <th>14244</th>
      <td>12/31/2020</td>
      <td>2.93</td>
    </tr>
  </tbody>
</table>
<p>14245 rows × 2 columns</p>
</div></div></div>
</div>
<p>With all settings and input data in place, we can run MATILDA with <strong>default parameters</strong>.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matilda.core</span> <span class="kn">import</span> <span class="n">matilda_simulation</span>

<span class="n">output_matilda</span> <span class="o">=</span> <span class="n">matilda_simulation</span><span class="p">(</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>---
MATILDA framework
Reading parameters for MATILDA simulation
Parameter set:
set_up_start     1998-01-01
set_up_end       1999-12-31
sim_start        2000-01-01
sim_end          2020-12-31
freq                      M
freq_long           Monthly
lat               42.185117
area_cat         300.663718
area_glac         31.829413
ele_dat         3324.555552
ele_cat         3271.895648
ele_glac        4001.879883
ele_non_glac    3185.467059
warn                  False
CFR_ice                0.01
lr_temp              -0.006
lr_prec                   0
TT_snow                   0
TT_diff                   2
CFMAX_snow              2.5
CFMAX_rel                 2
BETA                    1.0
CET                    0.15
FC                      250
K0                    0.055
K1                    0.055
K2                     0.04
LP                      0.7
MAXBAS                  3.0
PERC                    1.5
UZL                     120
PCORR                   1.0
SFCF                    0.7
CWH                     0.1
AG                      0.7
CFR                    0.15
hydro_year               10
pfilter                   0
TT_rain                   2
CFMAX_ice               5.0
dtype: object
*-------------------*
Reading data
Set up period from 1998-01-01 to 1999-12-31 to set initial values
Simulation period from 2000-01-01 to 2020-12-31
Input data preprocessing successful
---
Initiating MATILDA simulation
Recalculating initial elevations based on glacier profile
&gt;&gt; Prior glacier elevation: 4001.8798828125m a.s.l.
&gt;&gt; Recalculated glacier elevation: 3951m a.s.l.
&gt;&gt; Prior non-glacierized elevation: 3185m a.s.l.
&gt;&gt; Recalculated non-glacierized elevation: 3191m a.s.l.
Calculating glacier evolution
*-------------------*
Running HBV routine
Finished spin up for initial HBV parameters
Finished HBV routine
*-------------------*
** Model efficiency based on Monthly aggregates **
KGE coefficient: 0.36
NSE coefficient: -1.03
RMSE: 70.5
MARE coefficient: 0.77
*-------------------*
       avg_temp_catchment  avg_temp_glaciers  evap_off_glaciers  \
count            6086.000           6086.000           6086.000   
mean               -3.352             -7.912              0.801   
std                 9.208              9.208              1.015   
min               -25.237            -29.796              0.000   
25%               -11.536            -16.096              0.000   
50%                -2.678             -7.240              0.248   
75%                 5.182              0.620              1.504   
max                13.816              9.260              5.660   
sum            -20402.896         -48149.965           4875.092   

       prec_off_glaciers  prec_on_glaciers  rain_off_glaciers  \
count           6086.000          6086.000           6086.000   
mean               3.190             0.297              2.243   
std                4.887             0.460              4.871   
min                0.000             0.000              0.000   
25%                0.148             0.014              0.000   
50%                1.252             0.120              0.000   
75%                4.229             0.393              2.180   
max               54.234             5.569             54.234   
sum            19414.599          1808.011          13650.309   

       snow_off_glaciers  rain_on_glaciers  snow_on_glaciers  \
count           6086.000          6086.000          6086.000   
mean               0.947             0.141             0.157   
std                1.964             0.416             0.264   
min                0.000             0.000             0.000   
25%                0.000             0.000             0.000   
50%                0.018             0.000             0.034   
75%                0.960             0.012             0.207   
max               18.959             5.569             2.441   
sum             5764.290           855.414           952.597   

       snowpack_off_glaciers  ...  total_refreezing       SMB  \
count               6086.000  ...          6086.000  6086.000   
mean                 112.364  ...             0.048    -1.077   
std                  103.724  ...             0.184     7.035   
min                    0.000  ...             0.000   -41.042   
25%                    0.000  ...             0.000     0.000   
50%                  103.188  ...             0.000     0.228   
75%                  193.364  ...             0.020     1.854   
max                  441.425  ...             3.195    23.408   
sum               683849.122  ...           294.571 -6556.451   

       actual_evaporation  total_precipitation  total_melt  \
count            6086.000             6086.000    6086.000   
mean                0.789                3.487       1.292   
std                 1.001                5.342       3.138   
min                 0.000                0.000       0.000   
25%                 0.000                0.162       0.000   
50%                 0.241                1.373       0.000   
75%                 1.481                4.625       0.994   
max                 5.660               59.803      24.396   
sum              4801.992            21222.609    7861.505   

       runoff_without_glaciers  runoff_from_glaciers  runoff_ratio  \
count                 6086.000              6086.000  6.086000e+03   
mean                     2.434                 0.406  1.387727e+06   
std                      3.096                 0.882  1.082381e+08   
min                      0.000                 0.000  0.000000e+00   
25%                      0.036                 0.000  8.200000e-02   
50%                      0.704                 0.000  7.010000e-01   
75%                      4.238                 0.252  3.410000e+00   
max                     17.704                 7.219  8.443958e+09   
sum                  14815.019              2469.454  8.445704e+09   

       total_runoff  observed_runoff  
count      6086.000         6086.000  
mean          2.840            1.970  
std           3.591            1.690  
min           0.000            0.230  
25%           0.036            0.690  
50%           0.710            1.106  
75%           5.377            3.046  
max          19.722            8.822  
sum       17284.473        11988.054  

[9 rows x 28 columns]
End of the MATILDA simulation
---
</pre></div>
</div>
<img alt="_images/f025a93bc924c401d08b7b3f4fe05da855741bb75ee1d0bec1abb3d0eedf61f7.png" src="_images/f025a93bc924c401d08b7b3f4fe05da855741bb75ee1d0bec1abb3d0eedf61f7.png" />
<img alt="_images/0c2e6bb2673acf2e3fabf77535e59fa2e75257f9276aa56f823ce2827543c808.png" src="_images/0c2e6bb2673acf2e3fabf77535e59fa2e75257f9276aa56f823ce2827543c808.png" />
<img alt="_images/52db92e8db7fc798f5d99fa0d10b4d779538ca57c79fe202aecf474848c91801.png" src="_images/52db92e8db7fc798f5d99fa0d10b4d779538ca57c79fe202aecf474848c91801.png" />
</div>
</div>
<p>The results are obviously far from reality and largely overestimate runoff. The <strong>Kling-Gupta Efficiency coefficient (<a class="reference external" href="https://doi.org/10.1029/2011WR010962">KGE</a>)</strong> rates the result as 0.36 with 1.0 being a perfect match with the observations. We can also see that the input precipitation is much higher than the total runoff. Clearly, <strong>the model needs calibration</strong>.</p>
</section>
<section id="calibrate-matilda">
<h2>Calibrate MATILDA<a class="headerlink" href="#calibrate-matilda" title="Link to this heading">#</a></h2>
<p>In order to adjust the model parameters to the catchment characteristics, we will perform an <strong>automated calibration</strong>. The <a class="reference external" href="https://github.com/cryotools/matilda">MATILDA Python package</a> contains a calibration module called <em><a class="reference external" href="https://github.com/cryotools/matilda/blob/master/matilda/mspot_glacier.py">matilda.mspot</a></em> that makes extensive use of the Statistical Parameter Optimization Tool for Python (<a class="reference external" href="https://doi.org/10.1371/journal.pone.0145180">SPOTPY</a>). As we have seen, there can be large uncertainties in the input data (especially precipitation). Simply tuning the model parameters to match the observed hydrograph may over- or underestimate other runoff contributors, such as glacier melt, to compensate for deficiencies in the precipitation data. Therefore, it is good practice to include additional data sets in a <strong>multi-objective calibration</strong>. In this workflow we will use:</p>
<ul class="simple">
<li><p>remote sensing estimates of <strong>glacier surface mass balance</strong> (<strong>SMB</strong>) and …</p></li>
<li><p>…<strong>snow water equivalent</strong> (<strong>SWE</strong>) estimates from a dedicated snow reanalysis product.</p></li>
</ul>
<p>Unfortunately, both default datasets are <strong>limited to High Mountain Asia (HMA)</strong>. For study sites in other areas, please consult other sources and manually add the target values for calibration in the appropriate code cells. We are happy to include additional datasets as long as they are available online and can be integrated into the workflow.</p>
<div class="alert alert-block alert-info">
<b>Note:</b> Statistical parameter optimization (SPOT) algorithms require a high number of model runs, especially for large parameter sets. <i>mybinder.org</i> offers a maximum of two cores per user. One MATILDA calibration run for 20 years takes roughly 3s on one core. Therefore, large optimization runs in an online environment will be slow and may require you to leave the respective browser tab in the foreground for hours. To speed things up, you can either:
<div style="margin-left: 20px; margin-top: 12px;">
    ... run this notebook <b>locally on a computer with more cores</b> (ideally a high performance cluster) or <br>
    ... <b>reduce the number of calibration parameters</b> based on global sensitivity. We will return to this topic <a href="#Sensitivity-Analysis-with-FAST">later in this notebook</a>.
</div>
</div>
<p>For now, we will demonstrate how to use the SPOT features and then <strong>continue with a parameter set from a large HPC optimization run</strong>. If you need help implementing the routine on your HPC, consult the <a class="reference external" href="https://spotpy.readthedocs.io/en/latest/Advanced_hints/#mpi-parallel-computing">SPOTPY documentation</a> and <a class="reference external" href="https://github.com/phiscu/matilda_edu/issues/new">contact us</a> if you encounter problems.</p>
<section id="glacier-surface-mass-balance-data">
<h3>Glacier surface mass balance data<a class="headerlink" href="#glacier-surface-mass-balance-data" title="Link to this heading">#</a></h3>
<p>There are various sources of SMB records but only remote sensing estimates provide data for (almost) all glaciers in the target catchment. <a class="reference external" href="https://doi.org/10.3389/feart.2019.00363">Shean et. al. 2020 </a> calculated geodetic mass balances for all glaciers in High Mountain Asia from 2000 to 2018. For this example (and all other catchments in HMA), we can use their data set so derive an average annual mass balance in the calibration period.</p>
<div class="alert alert-block alert-info">
<b>Note:</b> As all remote sensing estimates the used dataset has significant uncertainties. A comparison to other datasets and the impact on the modeling results are discussed in the associated publication. </div>
<p>We pick all individual mass balance records that match the glacier IDs in our catchment and calculate the catchment-wide mean. In addition, we use the uncertainty estimate provided in the dataset to derive an uncertainty range.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">mass_balances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_input</span> <span class="o">+</span> <span class="s1">&#39;/hma_mb_20190215_0815_rmse.csv&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RGIId&#39;</span><span class="p">,</span> <span class="s1">&#39;mb_mwea&#39;</span><span class="p">,</span> <span class="s1">&#39;mb_mwea_sigma&#39;</span><span class="p">])</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;/RGI/Glaciers_in_catchment.csv&#39;</span><span class="p">)</span>

<span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mass_balances</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;RGIId&#39;</span><span class="p">)</span>
<span class="n">mean_mb</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;mb_mwea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>   <span class="c1"># Mean catchment MB in mm w.e.</span>
<span class="n">mean_sigma</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;mb_mwea_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_mb</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Mean uncertainty of catchment MB in mm w.e.</span>

<span class="n">target_mb</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_mb</span> <span class="o">-</span> <span class="n">mean_sigma</span><span class="p">,</span> <span class="n">mean_mb</span> <span class="o">+</span> <span class="n">mean_sigma</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Target glacier mass balance for calibration: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mean_mb</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; +-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mean_sigma</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;mm w.e.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Target glacier mass balance for calibration: -155.474 +-50.3mm w.e.
</pre></div>
</div>
</div>
</div>
</section>
<section id="snow-water-equivalent">
<h3>Snow water equivalent<a class="headerlink" href="#snow-water-equivalent" title="Link to this heading">#</a></h3>
<p>For snow cover estimates, we will use a dedicated <strong>snow reanalysis</strong> dataset from <a class="reference external" href="https://doi.org/10.5067/HNAUGJQXSCVU">Liu et. al. 2021</a>. Details on the data can be found in the dataset documentation and the associated <a class="reference external" href="https://doi.org/10.1029/2022GL100082">publication</a>.
Unfortunately, access to the dataset requires a (free) registration at <strong>NASA’s EarthData</strong> portal, which prevents a seamless integration. Also, the dataset consists of large files and requires some pre-processing that <strong>could not be done in a Jupyter Notebook</strong>. However, we provide you with the <code class="docutils literal notranslate"><span class="pre">SWEETR</span></code> tool, a <strong>fully automated workflow</strong> that you can run on your local computer to download, process, and aggregate the data. Please refer to the dedicated <a class="reference external" href="https://github.com/phiscu/hma_snow">Github repository</a> for further instructions.</p>
<img src="images/mean_swe_example.png" alt="Mean_SWE" width="400"><p>When you run the <code class="docutils literal notranslate"><span class="pre">SWEETR</span></code> tool with your catchment outline, it returns cropped raster files as the one shown above and, more importantly, a <strong>timeseries of catchment-wide daily mean SWE</strong> from 1999 to 2016. Just replace the <code class="docutils literal notranslate"><span class="pre">input/swe.csv</span></code> file with your result. Now we can load the timeseries as a dataframe.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">swe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dir_input</span><span class="si">}</span><span class="s1">/swe.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Along with the cropped SWE rasters the <code class="docutils literal notranslate"><span class="pre">SWEETR</span></code> tool creates binary masks for seasonal- and non-seasonal snow. Due to its strong signal in remote sensing data, seasonal snow can be better detected leading to more robust SWE estimates. However, the non-seasonal snow largely agrees with the glacierized area. Therefore, we will calibrate the snow routine by comparing the SWE of the ice-free sub-catchment with the seasonal snow of the reanalysis. Since the latter has a coarse resolution of 500 m, the excluded catchment area is a bit larger than the RGI glacier outlines (in the example: 17.2% non-seasonal snow vs. 10.8% glacierized sub-catchment). Therefore, we use a scaling factor to account for this mismatch in the reference area.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">glac_ratio</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;area_glac&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;area_cat&#39;</span><span class="p">]</span>       <span class="c1"># read glacieriezed and total area from the settings</span>
<span class="n">swe_area_sim</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">glac_ratio</span>
<span class="n">swe_area_obs</span> <span class="o">=</span> <span class="mf">0.828</span>                                            <span class="c1"># 1 - non-seasonal snow / seasonal snow</span>
<span class="n">sf</span> <span class="o">=</span> <span class="n">swe_area_obs</span> <span class="o">/</span> <span class="n">swe_area_sim</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SWE scaling factor: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SWE scaling factor: 0.926
</pre></div>
</div>
</div>
</div>
<p>The MATILDA framework provides an interface for <a class="reference external" href="https://github.com/thouska/spotpy/">SPOTPY</a>. Here we will use the <code class="docutils literal notranslate"><span class="pre">psample()</span></code> function to run MATILDA with the same settings as before but varying parameters. To do this, we will remove redundant <code class="docutils literal notranslate"><span class="pre">settings</span></code> and add some new ones specific to the function. Be sure to choose the number of repetitions carefully.</p>
<div class="alert alert-block alert-info">
<b>Note:</b> A latin hypercube sampling with only 5 samples does not actually make sense but the number is chosen for demonstration purposes. </div><div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tools.helpers</span> <span class="kn">import</span> <span class="n">drop_keys</span>

<span class="n">psample_settings</span> <span class="o">=</span> <span class="n">drop_keys</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="s1">&#39;plots&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_type&#39;</span><span class="p">])</span>

<span class="n">additional_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rep&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>                             <span class="c1"># Number of model runs. For advice, check the documentation of the algorithms.</span>
                       <span class="s1">&#39;glacier_only&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>                 <span class="c1"># True when calibrating an entirely glacierized catchment</span>
                       <span class="s1">&#39;obj_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;maximize&#39;</span><span class="p">,</span>                 <span class="c1"># Maximize (e.g. NSE) or minimize (e.g. RMSE) the objective function </span>
                       <span class="s1">&#39;target_mb&#39;</span><span class="p">:</span> <span class="n">mean_mb</span><span class="p">,</span>                  <span class="c1"># Average annual glacier mass balance to target at</span>
                       <span class="s1">&#39;target_swe&#39;</span><span class="p">:</span> <span class="n">swe</span><span class="p">,</span>                     <span class="c1"># Catchment-wide mean SWE timeseries of seasonal snow to calibrate the snow routine</span>
                       <span class="s1">&#39;swe_scaling&#39;</span><span class="p">:</span> <span class="mf">0.928</span><span class="p">,</span>                  <span class="c1"># scaling factor for simulated SWE to account for reference area mismatch</span>
                       <span class="s1">&#39;dbformat&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                      <span class="c1"># Write the results to a file (&#39;csv&#39;, &#39;hdf5&#39;, &#39;ram&#39;, &#39;sql&#39;) or not (&#39;None&#39;)</span>
                       <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                        <span class="c1"># Choose where to store the files</span>
                       <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;lhs&#39;</span><span class="p">,</span>                    <span class="c1"># Select the algorithm (for parallelization: mc, lhs, fast, rope, sceua or demcz)</span>
                       <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="s1">&#39;era5_matilda_example&#39;</span><span class="p">,</span>      <span class="c1"># Name the database</span>
                       
                       <span class="s1">&#39;parallel&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>                     <span class="c1"># Distribute the calculation on multiple cores or not</span>
                      <span class="c1"># &#39;cores&#39;: 20                           # Set number of cores when running in parallel</span>
                      <span class="p">}</span>
<span class="n">psample_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">additional_settings</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Settings for calibration runs:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">psample_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">psample_settings</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Settings for calibration runs:

area_cat: 300.6637184185051
area_glac: 31.829413146586116
ele_cat: 3271.895648388366
ele_dat: 3324.5555520312164
ele_glac: 4001.8798828125
elev_rescaling: True
freq: M
lat: 42.18511742495568
set_up_end: 1999-12-31
set_up_start: 1998-01-01
sim_end: 2020-12-31
sim_start: 2000-01-01
glacier_profile:      Elevation      Area          WE  EleZone  norm_elevation   delta_h
0         1970  0.000000      0.0000     1900        1.000000  1.003442
1         2000  0.000000      0.0000     2000        0.989324  0.945813
2         2100  0.000000      0.0000     2100        0.953737  0.774793
3         2200  0.000000      0.0000     2200        0.918149  0.632696
4         2300  0.000000      0.0000     2300        0.882562  0.515361
..         ...       ...         ...      ...             ...       ...
156       4730  0.000023  20721.3700     4700        0.017794 -0.000265
157       4740  0.000012  14450.2180     4700        0.014235 -0.000692
158       4750  0.000006  10551.4730     4700        0.010676 -0.001119
159       4760  0.000000      0.0000     4700        0.007117 -0.001546
160       4780  0.000002   6084.7456     4700        0.000000 -0.002400

[161 rows x 6 columns]
rep: 5
glacier_only: False
obj_dir: maximize
target_mb: -155.474
target_swe:             Date  SWE_Mean
0     1999-10-01    0.0003
1     1999-10-02    0.0002
2     1999-10-03    0.0001
3     1999-10-04    0.0001
4     1999-10-05    0.0000
...          ...       ...
6570  2017-09-26    0.0020
6571  2017-09-27    0.0021
6572  2017-09-28    0.0020
6573  2017-09-29    0.0022
6574  2017-09-30    0.0023

[6575 rows x 2 columns]
swe_scaling: 0.928
dbformat: None
output: None
algorithm: lhs
dbname: era5_matilda_example
parallel: False
</pre></div>
</div>
</div>
</div>
<p>With these settings we can start <code class="docutils literal notranslate"><span class="pre">psample()</span></code> to run our model with various parameter combinations. The default parameter boundaries can be found in the MATILDA <a class="reference external" href="https://github.com/cryotools/matilda/tree/master?tab=readme-ov-file#parameter-list">parameter documentation</a>. If you want to narrow down the parameter space, you can do that using the following syntax. Here, we define custom ranges for the temperature lapse rate and the precipitation correction factor and run a short Latin Hypercube Sampling (LHS) for demonstration.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matilda.mspot_glacier</span> <span class="kn">import</span> <span class="n">psample</span>

<span class="n">lim_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lr_temp_lo&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.007</span><span class="p">,</span> <span class="s1">&#39;lr_temp_up&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="s1">&#39;PCORR_lo&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;PCORR_up&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">}</span>

<span class="n">best_summary</span> <span class="o">=</span> <span class="n">psample</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">psample_settings</span><span class="p">,</span> <span class="o">**</span><span class="n">lim_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initializing the  Latin Hypercube Sampling (LHS)  with  5  repetitions
The objective function will be maximized
Starting the LHS algotrithm with 5 repetitions...
Creating LatinHyperCube Matrix
Initialize database...
[&#39;csv&#39;, &#39;hdf5&#39;, &#39;ram&#39;, &#39;sql&#39;, &#39;custom&#39;, &#39;noData&#39;]
2 of 5, maximal objective function=0.44177, time remaining: 00:00:02
4 of 5, maximal objective function=0.44177, time remaining: 00:00:00

*** Final SPOTPY summary ***
Total Duration: 6.17 seconds
Total Repetitions: 5
Maximal objective value: 0.44177
Corresponding parameter setting:
lr_temp: -0.00691643
lr_prec: 8.50519e-05
BETA: 2.21851
CET: 0.0128426
FC: 69.4315
K0: 0.105501
K1: 0.105936
K2: 0.00727363
LP: 0.472542
MAXBAS: 6.5398
PERC: 0.734797
UZL: 20.8619
PCORR: 0.909587
TT_snow: -0.758406
TT_diff: 0.993137
CFMAX_snow: 0.922814
CFMAX_rel: 1.39574
SFCF: 0.645042
CWH: 0.00853873
AG: 0.907078
CFR: 0.0586441
******************************

WARNING: The selected algorithm lhs can either maximize or minimize the objective function. You can specify the direction by passing obj_dir to analyze_results(). The default is &#39;maximize&#39;.
Best parameter set:
lr_temp=-0.006916433303633973, lr_prec=8.505193217634383e-05, BETA=2.2185085061572565, CET=0.012842592000137376, FC=69.43147499044507, K0=0.10550089689773379, K1=0.10593600409417982, K2=0.007273629711859898, LP=0.4725422547774313, MAXBAS=6.539796929779941, PERC=0.7347965883465084, UZL=20.861868451471572, PCORR=0.9095868348344598, TT_snow=-0.7584055354597998, TT_diff=0.993137443731672, CFMAX_snow=0.9228136573376893, CFMAX_rel=1.395744338338515, SFCF=0.6450421852712184, CWH=0.008538730800447977, AG=0.9070777501856488, CFR=0.05864413463214784
Run number 0 has the highest objectivefunction with: 0.4418
</pre></div>
</div>
</div>
</div>
<p>In this example the function ran the model 5 times with different parameter sets and returned the one with the highest KGE score. It can be accessed from the results dictionary.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_parameterset</span> <span class="o">=</span> <span class="n">best_summary</span><span class="p">[</span><span class="s1">&#39;best_param&#39;</span><span class="p">]</span>
<span class="c1"># Rounding all values for readability</span>
<span class="n">rounded_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">best_parameterset</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rounded_parameters</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;lr_temp&#39;: -0.007, &#39;lr_prec&#39;: 0.0, &#39;BETA&#39;: 2.219, &#39;CET&#39;: 0.013, &#39;FC&#39;: 69.431, &#39;K0&#39;: 0.106, &#39;K1&#39;: 0.106, &#39;K2&#39;: 0.007, &#39;LP&#39;: 0.473, &#39;MAXBAS&#39;: 6.54, &#39;PERC&#39;: 0.735, &#39;UZL&#39;: 20.862, &#39;PCORR&#39;: 0.91, &#39;TT_snow&#39;: -0.758, &#39;TT_diff&#39;: 0.993, &#39;CFMAX_snow&#39;: 0.923, &#39;CFMAX_rel&#39;: 1.396, &#39;SFCF&#39;: 0.645, &#39;CWH&#39;: 0.009, &#39;AG&#39;: 0.907, &#39;CFR&#39;: 0.059}
</pre></div>
</div>
</div>
</div>
<p>Of course, to properly cover the full parameter space you would need way more repetitions. However, a high number of samples and a high KGE score don’t necessarily give you the parameter set that describes the features of your catchment the best. To find the parameter combination most suitable to simulate the processes governing streamflow, we propose to calibrate MATILDA in several steps.</p>
</section>
</section>
<section id="process-based-calibration">
<h2>Process-based calibration<a class="headerlink" href="#process-based-calibration" title="Link to this heading">#</a></h2>
<p>Each parameter governs a different aspect of the water balance, and not all parameters influence every calibration variable. Therefore, we propose an <strong>iterative process-based calibration</strong> approach where we calibrate parameters in order of their importance using different algorithms, objective functions, and calibration variables. Details on the calibration strategy can be found in the model publication which is currently under review. Here, we only provide code examples with 10 samples per step for demonstration purposes. For ideal number of samples please refer to the associated publication.</p>
<img src="images/calibration_strategy.png" alt="calibration" width="300">
<section id="step-1-input-correction">
<h3>Step 1: Input correction<a class="headerlink" href="#step-1-input-correction" title="Link to this heading">#</a></h3>
<p>Three HBV parameters correct for errors in the input precipitation, snowfall, and evaporation data. They have by far the largest impact on simulated runoff and must be corrected first. The correction factors are primarily designed to correct for observational errors, such as undercatch of solid precipitation. The best way to determine these parameters depends on your study site and available observations. In this example, we disable the correction factors for snowfall (<code class="docutils literal notranslate"><span class="pre">SFCF=0</span></code>) and evaporation (<code class="docutils literal notranslate"><span class="pre">CET=0</span></code>), leaving the input data unchanged, to focus on the model’s internal sensitivities rather than the input data sets. However, the ERA5-Land dataset overestimates precipitation frequency and amounts in mountainous regions. A comparison of the monthly summer precipitation (Apr-Sep) with the in-situ observations from 2008 to 2017 showed that ERA5-Land overestimates the total precipitation in the example catchment by more than 100% (<code class="docutils literal notranslate"><span class="pre">108±62%</span></code>). Since the precipitation correction factor (<code class="docutils literal notranslate"><span class="pre">PCORR</span></code>) was identified as the most influential parameter, we cannot avoid to carefully calibrate it to obtain realistic runoff rates.</p>
<p>To constrain <code class="docutils literal notranslate"><span class="pre">PCORR</span></code>, we split the remaining 19 parameters into two subsets:</p>
<div style="margin-left: 20px; margin-top: 12px;margin-bottom: 12px;">
    (1) parameters governing the water balance, and<br>
    (2) those controlling runoff timing,
</div>
<p>…with the latter set to default values. The results can then be filtered sequentially based on thresholds for <span class="math notranslate nohighlight">\(MAE_{smb}\)</span>, <span class="math notranslate nohighlight">\(KGE_{swe}\)</span>, and subsequently <span class="math notranslate nohighlight">\(KGE_{r}\)</span>. <code class="docutils literal notranslate"><span class="pre">PCORR</span></code> was set to the mean value of the posterior distribution for subsequent calibration steps.</p>
<p>First, we edit the settings to write results to a <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file and run random sampling for the parameter subset governing the runoff amount while fixing all other parameters.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Edit the settings to write results in a .csv file</span>
<span class="n">psample_settings</span><span class="p">[</span><span class="s1">&#39;dbformat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;csv&#39;</span>
<span class="n">psample_settings</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir_output</span>
<span class="n">psample_settings</span><span class="p">[</span><span class="s1">&#39;dbname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;calib_step1&#39;</span>

<span class="c1"># Run random sampling</span>
<span class="n">step1_summary</span> <span class="o">=</span> <span class="n">psample</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">psample_settings</span><span class="p">,</span>
			<span class="n">fix_param</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SFCF&#39;</span><span class="p">,</span> <span class="s1">&#39;CET&#39;</span><span class="p">,</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="s1">&#39;K0&#39;</span><span class="p">,</span> <span class="s1">&#39;K1&#39;</span><span class="p">,</span> <span class="s1">&#39;K2&#39;</span><span class="p">,</span> <span class="s1">&#39;MAXBAS&#39;</span><span class="p">,</span> <span class="s1">&#39;PERC&#39;</span><span class="p">,</span> <span class="s1">&#39;UZL&#39;</span><span class="p">,</span> <span class="s1">&#39;CWH&#39;</span><span class="p">,</span> <span class="s1">&#39;AG&#39;</span><span class="p">,</span> <span class="s1">&#39;LP&#39;</span><span class="p">,</span> <span class="s1">&#39;CFR&#39;</span><span class="p">],</span>    <span class="c1"># fixed on defaults</span>
			<span class="n">fix_val</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SFCF&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;CET&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>                                                                            <span class="c1"># fixed on specific values</span>
		       <span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initializing the  Latin Hypercube Sampling (LHS)  with  5  repetitions
The objective function will be maximized
Starting the LHS algotrithm with 5 repetitions...
Creating LatinHyperCube Matrix
Initialize database...
[&#39;csv&#39;, &#39;hdf5&#39;, &#39;ram&#39;, &#39;sql&#39;, &#39;custom&#39;, &#39;noData&#39;]
* Database file &#39;calib_step1.csv&#39; created.
2 of 5, maximal objective function=-0.390659, time remaining: 00:00:02
4 of 5, maximal objective function=0.348024, time remaining: 00:00:00

*** Final SPOTPY summary ***
Total Duration: 6.19 seconds
Total Repetitions: 5
Maximal objective value: 0.348024
Corresponding parameter setting:
lr_temp: -0.00567734
lr_prec: 0.00128468
BETA: 4.20638
PCORR: 0.667991
TT_snow: 0.959747
TT_diff: 0.723988
CFMAX_snow: 8.31543
CFMAX_rel: 1.66355
******************************

Fixed parameters:

SFCF: 1
CET: 0
FC: 250
K0: 0.055
K1: 0.055
K2: 0.04
MAXBAS: 3.0
PERC: 1.5
UZL: 120
CWH: 0.1
AG: 0.7
LP: 0.7
CFR: 0.15

NOTE: Fixed parameters are not listed in the final parameter set.

WARNING: The selected algorithm lhs can either maximize or minimize the objective function. You can specify the direction by passing obj_dir to analyze_results(). The default is &#39;maximize&#39;.
Best parameter set:
lr_temp=-0.005677342, lr_prec=0.0012846845, BETA=4.206376, PCORR=0.66799104, TT_snow=0.95974725, TT_diff=0.72398806, CFMAX_snow=8.315428, CFMAX_rel=1.6635491
Run number 2 has the highest objectivefunction with: 0.348
</pre></div>
</div>
</div>
</div>
<p>Next, we load the samples from the <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file and can apply appropriate filters to the data, if desired.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step1_samples</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_output</span><span class="si">}</span><span class="s2">calib_step1.csv&quot;</span><span class="p">)</span>

<span class="n">step1_samples</span> <span class="o">=</span> <span class="n">step1_samples</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">step1_samples</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KGE_Runoff&#39;</span><span class="p">,</span> <span class="s1">&#39;MAE_SMB&#39;</span><span class="p">,</span> <span class="s1">&#39;KGE_SWE&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">step1_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
<span class="n">step1_samples</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">step1_samples</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;par&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="c1"># Apply appropriate filters</span>
<span class="c1">#step1_samples = step1_samples[step1_samples[&#39;KGE_Runoff&#39;] &gt; 0.5]</span>
<span class="c1">#step1_samples = step1_samples[step1_samples[&#39;MAE_SMB&#39;] &lt; 100]</span>
<span class="c1">#step1_samples = step1_samples[step1_samples[&#39;KGE_SWE&#39;] &gt; 0.7]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">step1_samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   KGE_Runoff     MAE_SMB   KGE_SWE   lr_temp   lr_prec      BETA     PCORR  \
0   -0.390659  1073.24170 -2.261153 -0.006388  0.001160  2.985225  1.369155   
1   -1.316510   320.15020 -2.751702 -0.005921  0.000226  3.895593  1.733987   
2    0.348025  2252.76320  0.486708 -0.005677  0.001285  4.206376  0.667991   
3   -0.113842   794.07630 -0.609412 -0.005858  0.001646  1.567730  1.094947   
4   -0.721091    77.41376 -1.726754 -0.006103  0.000795  5.106836  1.462764   

    TT_snow   TT_diff  CFMAX_snow  CFMAX_rel  
0 -0.314071  1.658873    1.564831   1.858126  
1  0.232515  1.783685    6.005065   1.517305  
2  0.959747  0.723988    8.315428   1.663549  
3  0.419109  1.293263    6.597863   1.289595  
4 -1.165138  2.145316    4.268604   1.713474  
</pre></div>
</div>
</div>
</div>
<p>We then plot the posterior distributions for each parameter.</p>
<div class="alert alert-block alert-info">
<b>Note:</b> For very few samples they are likely to look very similar.</div><div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FuncFormatter</span>

<span class="c1"># Create a 2x4 matrix of subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="c1"># Plot posterior distributions for each parameter in the matrix of subplots</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step1_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:]):</span>  <span class="c1"># Exclude the first two columns</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">4</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">step1_samples</span><span class="p">[</span><span class="n">parameter</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="p">[</span><span class="n">step1_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">step1_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">4</span><span class="p">]]:</span>
        <span class="k">def</span> <span class="nf">format_ticks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="s1">e-4&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">)</span>  <span class="c1"># Adjust multiplier here for desired scientific notation</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">format_ticks</span><span class="p">))</span>
    <span class="c1"># Add vertical lines for mean, mean ± standard deviation</span>
    <span class="n">mean_val</span> <span class="o">=</span> <span class="n">step1_samples</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std_val</span> <span class="o">=</span> <span class="n">step1_samples</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/bd4c888e6a1e13151c82497e77ceafe36a07068c0d23351db95d43bf5cd4f3ae.png" src="_images/bd4c888e6a1e13151c82497e77ceafe36a07068c0d23351db95d43bf5cd4f3ae.png" />
</div>
</div>
<p>Finally, we calculate the mean and standard deviation for each parameter and write the results to a table.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate mean and standard deviation for each column</span>
<span class="n">stats_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">step1_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">step1_samples</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">step1_samples</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">stats_dict</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">stats_dict</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_stddev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># Write to table</span>
<span class="n">table_step1_samples</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">step1_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[:]:</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">step1_samples</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">step1_samples</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">table_step1_samples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="mi">5</span><span class="p">)])</span>

<span class="n">table_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">table_step1_samples</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Stdv&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">step1_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">table_df</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>               Mean     Stdv
lr_temp    -0.00599  0.00027
lr_prec     0.00102  0.00054
BETA        3.55235  1.34372
PCORR       1.26577  0.40474
TT_snow     0.02643  0.80677
TT_diff     1.52103  0.53965
CFMAX_snow  5.35036  2.56305
CFMAX_rel   1.60841  0.21586
</pre></div>
</div>
</div>
</div>
<p>With an appropriate number of samples, these values will give you a good idea of the parameter distribution. In our example study, we’ll fix <code class="docutils literal notranslate"><span class="pre">PCORR</span></code> and few insensitive parameters (<code class="docutils literal notranslate"><span class="pre">lr_temp</span></code>, <code class="docutils literal notranslate"><span class="pre">lr_prec</span></code>; see the <a href="#Sensitivity-Analysis-with-FAST">Sensitivity Section</a> for details) on their mean values and use the standard deviation of the other parameters to define the bounds for subsequent calibration steps. The insensitive refreezing parameter <code class="docutils literal notranslate"><span class="pre">CFR</span></code> is fixed on it’s default value (0.15).</p>
</section>
<section id="step-2-snow-routine-calibration">
<h3>Step 2: Snow routine calibration<a class="headerlink" href="#step-2-snow-routine-calibration" title="Link to this heading">#</a></h3>
<p>Three of the remaining parameters control the snow routine: <code class="docutils literal notranslate"><span class="pre">TT_snow</span></code>, <code class="docutils literal notranslate"><span class="pre">TT_diff</span></code>, and <code class="docutils literal notranslate"><span class="pre">CFMAX_snow</span></code>. These parameters affect how snow accumulation and melting are simulated, making them critical for high mountain catchments. We repeat the procedure of step 1, but additionally fix all previously calibrated parameters. The results can then be filtered based on <strong><span class="math notranslate nohighlight">\(KGE_{swe}\)</span></strong>. As before, the selected snow routine parameters are set to the mean of the posterior distribution for use in subsequent calibration steps.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># New database name</span>
<span class="n">psample_settings</span><span class="p">[</span><span class="s1">&#39;dbname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;calib_step2&#39;</span>

<span class="c1"># Running LHS with only three open parameters</span>
<span class="n">step1_summary</span> <span class="o">=</span> <span class="n">psample</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">psample_settings</span><span class="p">,</span>
		        <span class="n">fix_param</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PCORR&#39;</span><span class="p">,</span> <span class="s1">&#39;SFCF&#39;</span><span class="p">,</span> <span class="s1">&#39;CET&#39;</span><span class="p">,</span> <span class="s1">&#39;lr_temp&#39;</span><span class="p">,</span> <span class="s1">&#39;lr_prec&#39;</span><span class="p">,</span> <span class="s1">&#39;K0&#39;</span><span class="p">,</span> <span class="s1">&#39;LP&#39;</span><span class="p">,</span> <span class="s1">&#39;MAXBAS&#39;</span><span class="p">,</span> <span class="s1">&#39;CFMAX_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;CFR&#39;</span><span class="p">,</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="s1">&#39;K1&#39;</span><span class="p">,</span> <span class="s1">&#39;K2&#39;</span><span class="p">,</span> <span class="s1">&#39;PERC&#39;</span><span class="p">,</span> <span class="s1">&#39;UZL&#39;</span><span class="p">,</span> <span class="s1">&#39;CWH&#39;</span><span class="p">,</span> <span class="s1">&#39;AG&#39;</span><span class="p">,</span> <span class="s1">&#39;BETA&#39;</span><span class="p">],</span>
		        <span class="n">fix_val</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;PCORR&#39;</span><span class="p">:</span> <span class="mf">0.58</span><span class="p">,</span> <span class="s1">&#39;SFCF&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;CET&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;lr_temp&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0061</span><span class="p">,</span> <span class="s1">&#39;lr_prec&#39;</span><span class="p">:</span> <span class="mf">0.0015</span><span class="p">,</span> <span class="s1">&#39;CFR&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">},</span>
		       <span class="p">)</span>

<span class="c1"># Reading the samples from file</span>
<span class="n">step2_samples</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_output</span><span class="si">}</span><span class="s2">calib_step2.csv&quot;</span><span class="p">)</span>
<span class="n">step2_samples</span> <span class="o">=</span> <span class="n">step2_samples</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">step2_samples</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KGE_Runoff&#39;</span><span class="p">,</span> <span class="s1">&#39;MAE_SMB&#39;</span><span class="p">,</span> <span class="s1">&#39;KGE_SWE&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">step2_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
<span class="n">step2_samples</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">step2_samples</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;par&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="c1"># Apply appropriate filters</span>
<span class="c1">#step2_samples = step2_samples[step2_samples[&#39;KGE_SWE&#39;] &gt; 0.8]</span>

<span class="c1"># Create a 1x3 matrix of subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1"># Plot posterior distributions for each parameter in the matrix of subplots</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step2_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]):</span>  <span class="c1"># Exclude the first two columns</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">step2_samples</span><span class="p">[</span><span class="n">parameter</span><span class="p">],</span> <span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="c1"># Add vertical lines for mean, mean ± standard deviation</span>
    <span class="n">mean_val</span> <span class="o">=</span> <span class="n">step2_samples</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std_val</span> <span class="o">=</span> <span class="n">step2_samples</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_val</span> <span class="o">-</span> <span class="n">std_val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean - SD&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_val</span> <span class="o">+</span> <span class="n">std_val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean + SD&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Calculate mean and standard deviation for each parameter</span>
<span class="n">stats_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">step2_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">step2_samples</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">step2_samples</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">stats_dict</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">stats_dict</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_stddev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># Write to table</span>
<span class="n">table_step2_samples</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">step2_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[:]:</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">step2_samples</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">step2_samples</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">table_step2_samples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="mi">5</span><span class="p">)])</span>

<span class="n">table_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">table_step2_samples</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Stdv&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">step2_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="c1"># Show calibrated values</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calibrated values:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">table_df</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initializing the  Latin Hypercube Sampling (LHS)  with  5  repetitions
The objective function will be maximized
Starting the LHS algotrithm with 5 repetitions...
Creating LatinHyperCube Matrix
Initialize database...
[&#39;csv&#39;, &#39;hdf5&#39;, &#39;ram&#39;, &#39;sql&#39;, &#39;custom&#39;, &#39;noData&#39;]
* Database file &#39;calib_step2.csv&#39; created.
2 of 5, maximal objective function=0.489585, time remaining: 00:00:02
4 of 5, maximal objective function=0.489585, time remaining: 00:00:00

*** Final SPOTPY summary ***
Total Duration: 6.28 seconds
Total Repetitions: 5
Maximal objective value: 0.489585
Corresponding parameter setting:
TT_snow: -0.350142
TT_diff: 0.880536
CFMAX_snow: 2.30342
******************************

Fixed parameters:

PCORR: 0.58
SFCF: 1
CET: 0
lr_temp: -0.0061
lr_prec: 0.0015
K0: 0.055
LP: 0.7
MAXBAS: 3.0
CFMAX_rel: 2
CFR: 0.15
FC: 250
K1: 0.055
K2: 0.04
PERC: 1.5
UZL: 120
CWH: 0.1
AG: 0.7
BETA: 1.0

NOTE: Fixed parameters are not listed in the final parameter set.

WARNING: The selected algorithm lhs can either maximize or minimize the objective function. You can specify the direction by passing obj_dir to analyze_results(). The default is &#39;maximize&#39;.
Best parameter set:
TT_snow=-0.35014173, TT_diff=0.8805357, CFMAX_snow=2.3034182
Run number 1 has the highest objectivefunction with: 0.4896
</pre></div>
</div>
<img alt="_images/1c22a222ef01a3861d7f65903040833d0a6ba8e6b4abf8b546bb0b153db7376c.png" src="_images/1c22a222ef01a3861d7f65903040833d0a6ba8e6b4abf8b546bb0b153db7376c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calibrated values:
               Mean     Stdv
TT_snow     0.18864  0.87583
TT_diff     1.62704  0.58751
CFMAX_snow  5.84661  2.78856
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-3-glacier-routine-calibration">
<h3>Step 3: Glacier routine calibration<a class="headerlink" href="#step-3-glacier-routine-calibration" title="Link to this heading">#</a></h3>
<p>Since we already calibrated the snow routine, there is only one parameter left that controls glacier evolution: the ice melt rate <code class="docutils literal notranslate"><span class="pre">CFMAX_ice</span></code>. Since the melt rate for ice is higher than the one for snow due to differences in albedo, the parameter is calculated from the snow melt rate using a factor <code class="docutils literal notranslate"><span class="pre">CFMAX_rel</span></code>. We will therefore calibrate this factor instead of <code class="docutils literal notranslate"><span class="pre">CFMAX_ice</span></code> directly.</p>
<p>As before, we draw stratified random samples using the LHS algorithm and filter for a mean absolute error (<span class="math notranslate nohighlight">\(\text{MAE}\)</span>) threshold around the target SMB. To account for the large uncertainties in the remote sensing estimates for the SMB, we don’t fix the ice melt rate but constrain it to a range that lies with the uncertainty band of the dataset.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># New database name</span>
<span class="n">psample_settings</span><span class="p">[</span><span class="s1">&#39;dbname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;calib_step3&#39;</span>

<span class="c1"># Running LHS with only one open parameter</span>
<span class="n">step3_summary</span> <span class="o">=</span> <span class="n">psample</span><span class="p">(</span>
                        <span class="n">df</span><span class="o">=</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">psample_settings</span><span class="p">,</span>
                        <span class="n">fix_param</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PCORR&#39;</span><span class="p">,</span> <span class="s1">&#39;SFCF&#39;</span><span class="p">,</span> <span class="s1">&#39;CET&#39;</span><span class="p">,</span> <span class="s1">&#39;lr_temp&#39;</span><span class="p">,</span> <span class="s1">&#39;lr_prec&#39;</span><span class="p">,</span> <span class="s1">&#39;K0&#39;</span><span class="p">,</span> <span class="s1">&#39;LP&#39;</span><span class="p">,</span> <span class="s1">&#39;MAXBAS&#39;</span><span class="p">,</span> <span class="s1">&#39;CFR&#39;</span><span class="p">,</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="s1">&#39;K1&#39;</span><span class="p">,</span> <span class="s1">&#39;K2&#39;</span><span class="p">,</span> <span class="s1">&#39;PERC&#39;</span><span class="p">,</span> <span class="s1">&#39;UZL&#39;</span><span class="p">,</span> <span class="s1">&#39;CWH&#39;</span><span class="p">,</span> <span class="s1">&#39;AG&#39;</span><span class="p">,</span> <span class="s1">&#39;BETA&#39;</span><span class="p">,</span> <span class="s1">&#39;TT_snow&#39;</span><span class="p">,</span> <span class="s1">&#39;TT_diff&#39;</span><span class="p">,</span> <span class="s1">&#39;CFMAX_snow&#39;</span><span class="p">],</span>
                        <span class="n">fix_val</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;PCORR&#39;</span><span class="p">:</span> <span class="mf">0.58</span><span class="p">,</span> <span class="s1">&#39;SFCF&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;CET&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;lr_temp&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0061</span><span class="p">,</span> <span class="s1">&#39;lr_prec&#39;</span><span class="p">:</span> <span class="mf">0.0015</span><span class="p">,</span> <span class="s1">&#39;CFR&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;TT_snow&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.45</span><span class="p">,</span> <span class="s1">&#39;TT_diff&#39;</span><span class="p">:</span> <span class="mf">0.76</span><span class="p">,</span> <span class="s1">&#39;CFMAX_snow&#39;</span><span class="p">:</span> <span class="mf">3.37</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Reading the samples from file</span>
<span class="n">step3_samples</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_output</span><span class="si">}</span><span class="s2">calib_step3.csv&quot;</span><span class="p">)</span>
<span class="n">step3_samples</span> <span class="o">=</span> <span class="n">step3_samples</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">step3_samples</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KGE_Runoff&#39;</span><span class="p">,</span> <span class="s1">&#39;MAE_SMB&#39;</span><span class="p">,</span> <span class="s1">&#39;KGE_SWE&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">step3_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
<span class="n">step3_samples</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">step3_samples</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;par&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="c1"># Apply appropriate filters</span>
<span class="c1">#step3_samples = step3_samples[step3_samples[&#39;MAE_SMB&#39;] &lt; 100</span>

<span class="c1"># Use the range of values that meet the target SMB range as bound for the next calibration steps</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calibrated values:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CFMAX_rel lower bound: </span><span class="si">{</span><span class="n">step3_samples</span><span class="p">[</span><span class="s1">&#39;CFMAX_rel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">CFMAX_rel upper bound: </span><span class="si">{</span><span class="n">step3_samples</span><span class="p">[</span><span class="s1">&#39;CFMAX_rel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initializing the  Latin Hypercube Sampling (LHS)  with  5  repetitions
The objective function will be maximized
Starting the LHS algotrithm with 5 repetitions...
Creating LatinHyperCube Matrix
Initialize database...
[&#39;csv&#39;, &#39;hdf5&#39;, &#39;ram&#39;, &#39;sql&#39;, &#39;custom&#39;, &#39;noData&#39;]
* Database file &#39;calib_step3.csv&#39; created.
2 of 5, maximal objective function=0.563832, time remaining: 00:00:02
4 of 5, maximal objective function=0.563953, time remaining: 00:00:00

*** Final SPOTPY summary ***
Total Duration: 6.4 seconds
Total Repetitions: 5
Maximal objective value: 0.563953
Corresponding parameter setting:
CFMAX_rel: 1.42308
******************************

Fixed parameters:

PCORR: 0.58
SFCF: 1
CET: 0
lr_temp: -0.0061
lr_prec: 0.0015
K0: 0.055
LP: 0.7
MAXBAS: 3.0
CFR: 0.15
FC: 250
K1: 0.055
K2: 0.04
PERC: 1.5
UZL: 120
CWH: 0.1
AG: 0.7
BETA: 1.0
TT_snow: -1.45
TT_diff: 0.76
CFMAX_snow: 3.37

NOTE: Fixed parameters are not listed in the final parameter set.

WARNING: The selected algorithm lhs can either maximize or minimize the objective function. You can specify the direction by passing obj_dir to analyze_results(). The default is &#39;maximize&#39;.
Best parameter set:
CFMAX_rel=1.4230833
Run number 2 has the highest objectivefunction with: 0.564

Calibrated values:
CFMAX_rel lower bound: 1.3589958
CFMAX_rel upper bound: 1.858667
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-4-soil-and-routing-routine-calibration">
<h3>Step 4: Soil and routing routine calibration<a class="headerlink" href="#step-4-soil-and-routing-routine-calibration" title="Link to this heading">#</a></h3>
<p>In the last step we calibrate the remaining 11 parameters controlling the soil, response, and routing routines all at once. Since this leads to a large parameter space, we apply the Differential Evolution Markov Chain algorithm (DEMCz). This technique is more efficient at finding global optima than other Monte Carlo Markov Chain (MCMC) algorithms and does not require prior distribution information.</p>
<p>However, the algorithm is sensitive to informal likelihood functions such as the <span class="math notranslate nohighlight">\(\text{KGE}\)</span>. To mitigate this problem, we use an adapted version based on the gamma-distribution (<code class="docutils literal notranslate"><span class="pre">loglike_kge</span></code>).</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matilda.mspot_glacier</span> <span class="kn">import</span> <span class="n">loglike_kge</span>

<span class="c1"># New database name</span>
<span class="n">psample_settings</span><span class="p">[</span><span class="s1">&#39;dbname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;calib_step4&#39;</span>

<span class="c1"># Change algorithm</span>
<span class="n">psample_settings</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;demcz&#39;</span>

<span class="c1"># The algorithm needs a minimum sample size to run through</span>
<span class="n">psample_settings</span><span class="p">[</span><span class="s1">&#39;rep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># Running DEMCz with 11 open parameters</span>
<span class="n">step4_summary</span> <span class="o">=</span> <span class="n">psample</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">psample_settings</span><span class="p">,</span>
                <span class="c1"># obj_func=loglike_kge,</span>
                <span class="c1"># Optional arguments specific to the algorithm. Use for large sample sizes only!</span>
<span class="c1">#		        demcz_args={&#39;burnIn&#39;: 500, &#39;thin&#39;: 1, &#39;convergenceCriteria&#39;: 0.8},</span>
		        <span class="n">fix_param</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PCORR&#39;</span><span class="p">,</span> <span class="s1">&#39;SFCF&#39;</span><span class="p">,</span> <span class="s1">&#39;CET&#39;</span><span class="p">,</span> <span class="s1">&#39;CFR&#39;</span><span class="p">,</span> <span class="s1">&#39;lr_temp&#39;</span><span class="p">,</span> <span class="s1">&#39;lr_prec&#39;</span><span class="p">,</span> <span class="s1">&#39;TT_diff&#39;</span><span class="p">,</span> <span class="s1">&#39;TT_snow&#39;</span><span class="p">,</span> <span class="s1">&#39;CFMAX_snow&#39;</span><span class="p">],</span>
		        <span class="n">fix_val</span><span class="o">=</span><span class="p">{</span>
				    <span class="c1"># Fix:</span>
				    <span class="s1">&#39;CFR&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
				    <span class="s1">&#39;SFCF&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
				    <span class="s1">&#39;CET&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>

				    <span class="c1"># Step 1:</span>
				    <span class="s1">&#39;PCORR&#39;</span><span class="p">:</span> <span class="mf">0.58</span><span class="p">,</span>
				    <span class="s1">&#39;lr_temp&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.006</span><span class="p">,</span>
				    <span class="s1">&#39;lr_prec&#39;</span><span class="p">:</span> <span class="mf">0.0015</span><span class="p">,</span>

				    <span class="c1"># Step 2:</span>
				    <span class="s1">&#39;TT_diff&#39;</span><span class="p">:</span> <span class="mf">0.76198</span><span class="p">,</span>
				    <span class="s1">&#39;TT_snow&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.44646</span><span class="p">,</span>
				    <span class="s1">&#39;CFMAX_snow&#39;</span><span class="p">:</span> <span class="mf">3.3677</span>
				<span class="p">},</span>
                    <span class="c1"># Step 3:</span>
                    <span class="n">CFMAX_rel_lo</span><span class="o">=</span><span class="mf">1.2000372</span><span class="p">,</span>
                    <span class="n">CFMAX_rel_up</span><span class="o">=</span><span class="mf">1.5314099</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initializing the  Differential Evolution Markov Chain (DE-MC) algorithm  with  30  repetitions
The objective function will be maximized
Starting the DEMCz algotrithm with 30 repetitions...
Initialize database...
[&#39;csv&#39;, &#39;hdf5&#39;, &#39;ram&#39;, &#39;sql&#39;, &#39;custom&#39;, &#39;noData&#39;]
* Database file &#39;calib_step4.csv&#39; created.
2 of 30, maximal objective function=0.112952, time remaining: 00:00:24
4 of 30, maximal objective function=0.278135, time remaining: 00:00:26
6 of 30, maximal objective function=0.278135, time remaining: 00:00:25
8 of 30, maximal objective function=0.412269, time remaining: 00:00:24
10 of 30, maximal objective function=0.412269, time remaining: 00:00:22
12 of 30, maximal objective function=0.412269, time remaining: 00:00:20
14 of 30, maximal objective function=0.412269, time remaining: 00:00:18
16 of 30, maximal objective function=0.412269, time remaining: 00:00:15
18 of 30, maximal objective function=0.412269, time remaining: 00:00:13
20 of 30, maximal objective function=0.412269, time remaining: 00:00:11
22 of 30, maximal objective function=0.469495, time remaining: 00:00:08
24 of 30, maximal objective function=0.691296, time remaining: 00:00:06
0 100
26 of 30, maximal objective function=0.691296, time remaining: 00:00:04
1 100
28 of 30, maximal objective function=0.691296, time remaining: 00:00:01
30 of 30, maximal objective function=0.691296, time remaining: 23:59:59
Gelman Rubin R=inf

*** Final SPOTPY summary ***
Total Duration: 38.18 seconds
Total Repetitions: 30
Maximal objective value: 0.691296
Corresponding parameter setting:
BETA: 5.87937
FC: 371.752
K0: 0.310425
K1: 0.0297477
K2: 0.0149381
LP: 0.393737
MAXBAS: 6.59971
PERC: 1.79626
UZL: 364.867
CFMAX_rel: 1.32208
CWH: 0.151776
AG: 0.611111
******************************

Fixed parameters:

PCORR: 0.58
SFCF: 1
CET: 0
CFR: 0.15
lr_temp: -0.006
lr_prec: 0.0015
TT_diff: 0.76198
TT_snow: -1.44646
CFMAX_snow: 3.3677

NOTE: Fixed parameters are not listed in the final parameter set.

Best parameter set:
BETA=5.879372, FC=371.75165, K0=0.3104248, K1=0.029747725, K2=0.014938061, LP=0.3937367, MAXBAS=6.599707, PERC=1.7962637, UZL=364.86734, CFMAX_rel=1.3220805, CWH=0.15177554, AG=0.6111114
Run number 22 has the highest objectivefunction with: 0.6913
</pre></div>
</div>
</div>
</div>
<p>Again, we can apply various criteria to filter the samples, e.g. for the glacier mass balance (<span class="math notranslate nohighlight">\(MAE_{smb}\)</span>) and runff (<span class="math notranslate nohighlight">\(KGE_{r}\)</span>).</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reading the samples from file</span>
<span class="n">step4_samples</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_output</span><span class="si">}</span><span class="s2">calib_step4.csv&quot;</span><span class="p">)</span>
<span class="n">step4_samples</span> <span class="o">=</span> <span class="n">step4_samples</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">step4_samples</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KGE_Runoff&#39;</span><span class="p">,</span> <span class="s1">&#39;MAE_SMB&#39;</span><span class="p">,</span> <span class="s1">&#39;KGE_SWE&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">step4_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>

<span class="c1"># Apply appropriate filters</span>
<span class="c1"># data = data[data[&#39;KGE_Runoff&#39;] &gt; 800]            # loglike_KGE values rough equivalents: 700 =~0.85    max. 895 =~0.87</span>
<span class="c1"># data = data[data[&#39;MAE_SMB&#39;] &lt; 50]</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>We can now plot the posterior distribution of all 11 parameters and the calibration variables.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a 3x5 matrix of subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

<span class="c1"># Plot posterior distributions for each parameter in the matrix of subplots</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step4_samples</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># Exclude the &#39;chain&#39; column</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">5</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">5</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">step4_samples</span><span class="p">[</span><span class="n">parameter</span><span class="p">],</span> <span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Posterior Distribution of </span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/18e38b02a8dba04607201572fea7437e0a87dd360a841134e7a133dc9ce37f3e.png" src="_images/18e38b02a8dba04607201572fea7437e0a87dd360a841134e7a133dc9ce37f3e.png" />
</div>
</div>
<p>Depending on your sample size and filter criteria, there might still be a large number of possible parameter sets. To identify the best sample, you can either apply further criteria (e.g. seasonal <span class="math notranslate nohighlight">\(\text{KGE}\)</span> scores) or use visual methods.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="n">custom_text</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Index: </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&lt;br&gt;KGE_Runoff: </span><span class="si">{</span><span class="n">KGE_Runoff</span><span class="si">}</span><span class="s1">&lt;br&gt;MAE_SMB: </span><span class="si">{</span><span class="n">MAE_SMB</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">KGE_Runoff</span><span class="p">,</span> <span class="n">MAE_SMB</span><span class="p">)</span> <span class="ow">in</span>
               <span class="nb">zip</span><span class="p">(</span><span class="n">step4_samples</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">step4_samples</span><span class="p">[</span><span class="s1">&#39;KGE_Runoff&#39;</span><span class="p">],</span> <span class="n">step4_samples</span><span class="p">[</span><span class="s1">&#39;MAE_SMB&#39;</span><span class="p">])]</span>

<span class="c1"># Create a 2D scatter plot with custom text</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">step4_samples</span><span class="p">[</span><span class="s1">&#39;KGE_Runoff&#39;</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">step4_samples</span><span class="p">[</span><span class="s1">&#39;MAE_SMB&#39;</span><span class="p">],</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
    <span class="n">text</span><span class="o">=</span><span class="n">custom_text</span><span class="p">,</span> <span class="c1"># Assign custom text to each step4_samples point</span>
    <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>  <span class="c1"># Show custom text when hovering</span>
<span class="p">))</span>

<span class="c1"># Update layout</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Kling-Gupta-Efficiency score&#39;</span><span class="p">,</span>
    <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;MAE of mean annual SMB&#39;</span><span class="p">,</span>
    <span class="c1">#title=&#39;2D Scatter Plot of like1 and like2 with parPCORR Color Ramp&#39;,</span>
    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>  <span class="c1"># Adjust margins for better visualization</span>
<span class="p">)</span>

<span class="c1"># Show the plot</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
</div>
</div>
<p>When you identified the best run, you can get the respective parameter set using the index number (e.g run number 10).</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select ID of your best run</span>
<span class="n">best</span> <span class="o">=</span> <span class="n">step4_samples</span><span class="p">[</span><span class="n">step4_samples</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">10</span><span class="p">]</span>                     <span class="c1"># change accordingly</span>

<span class="c1"># Filter columns with the prefix &#39;par&#39;</span>
<span class="n">par_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">best</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;par&#39;</span><span class="p">)]</span>

<span class="c1"># Create a dictionary with keys as column names without the &#39;par&#39; prefix</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;par&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">best</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">par_columns</span><span class="p">}</span>

<span class="c1"># Print the dictionary</span>
<span class="nb">print</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;BETA&#39;: 1.0896775, &#39;FC&#39;: 91.535614, &#39;K0&#39;: 0.39396313, &#39;K1&#39;: 0.091763765, &#39;K2&#39;: 0.14183621, &#39;LP&#39;: 0.34399354, &#39;MAXBAS&#39;: 3.5683568, &#39;PERC&#39;: 0.66150236, &#39;UZL&#39;: 410.74466, &#39;CFMAX_rel&#39;: 1.215003, &#39;CWH&#39;: 0.08377623, &#39;AG&#39;: 0.5709083}
</pre></div>
</div>
</div>
</div>
<p>Together with your parameter values from previous steps, this is your calibrated parameter set you can use to run the projections.</p>
<p>This incremental calibration allows linking the parameters to the processes simulated instead of randomly fitting them to match the measured discharge. However, uncertainties in the calibration data still allow for a wide range of potential scenarios. For a detailed discussion please refer to the associated publication.</p>
</section>
</section>
<section id="run-matilda-with-calibrated-parameters">
<h2>Run MATILDA with calibrated parameters<a class="headerlink" href="#run-matilda-with-calibrated-parameters" title="Link to this heading">#</a></h2>
<p>The following parameter set was computed applying the mentioned calibration strategy on an HPC cluster with large sample sizes for every step.
<a id="param"></a></p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;CFR&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
    <span class="s1">&#39;SFCF&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;CET&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;PCORR&#39;</span><span class="p">:</span> <span class="mf">0.58</span><span class="p">,</span>
    <span class="s1">&#39;lr_temp&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.006</span><span class="p">,</span>
    <span class="s1">&#39;lr_prec&#39;</span><span class="p">:</span> <span class="mf">0.0015</span><span class="p">,</span>
    <span class="s1">&#39;TT_diff&#39;</span><span class="p">:</span> <span class="mf">0.76198</span><span class="p">,</span>
    <span class="s1">&#39;TT_snow&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.44646</span><span class="p">,</span>
    <span class="s1">&#39;CFMAX_snow&#39;</span><span class="p">:</span> <span class="mf">3.3677</span><span class="p">,</span>
    <span class="s1">&#39;BETA&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s1">&#39;FC&#39;</span><span class="p">:</span> <span class="mf">99.15976</span><span class="p">,</span>
    <span class="s1">&#39;K0&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="s1">&#39;K1&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="s1">&#39;K2&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
    <span class="s1">&#39;LP&#39;</span><span class="p">:</span> <span class="mf">0.998</span><span class="p">,</span>
    <span class="s1">&#39;MAXBAS&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="s1">&#39;PERC&#39;</span><span class="p">:</span> <span class="mf">0.09232826</span><span class="p">,</span>
    <span class="s1">&#39;UZL&#39;</span><span class="p">:</span> <span class="mf">126.411575</span><span class="p">,</span>
    <span class="s1">&#39;CFMAX_rel&#39;</span><span class="p">:</span> <span class="mf">1.2556936</span><span class="p">,</span>
    <span class="s1">&#39;CWH&#39;</span><span class="p">:</span> <span class="mf">0.000117</span><span class="p">,</span>
    <span class="s1">&#39;AG&#39;</span><span class="p">:</span> <span class="mf">0.54930484</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calibrated parameter set:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calibrated parameter set:


CFR: 0.15
SFCF: 1
CET: 0
PCORR: 0.58
lr_temp: -0.006
lr_prec: 0.0015
TT_diff: 0.76198
TT_snow: -1.44646
CFMAX_snow: 3.3677
BETA: 1.0
FC: 99.15976
K0: 0.01
K1: 0.01
K2: 0.15
LP: 0.998
MAXBAS: 2.0
PERC: 0.09232826
UZL: 126.411575
CFMAX_rel: 1.2556936
CWH: 0.000117
AG: 0.54930484
</pre></div>
</div>
</div>
</div>
<p>Properly calibrated, the model shows a much better results.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_matilda</span> <span class="o">=</span> <span class="n">matilda_simulation</span><span class="p">(</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>---
MATILDA framework
Reading parameters for MATILDA simulation
Parameter set:
set_up_start     1998-01-01
set_up_end       1999-12-31
sim_start        2000-01-01
sim_end          2020-12-31
freq                      M
freq_long           Monthly
lat               42.185117
area_cat         300.663718
area_glac         31.829413
ele_dat         3324.555552
ele_cat         3271.895648
ele_glac        4001.879883
ele_non_glac    3185.467059
warn                  False
CFR_ice                0.01
lr_temp              -0.006
lr_prec              0.0015
TT_snow            -1.44646
TT_diff             0.76198
CFMAX_snow           3.3677
CFMAX_rel          1.255694
BETA                    1.0
CET                       0
FC                 99.15976
K0                     0.01
K1                     0.01
K2                     0.15
LP                    0.998
MAXBAS                  2.0
PERC               0.092328
UZL              126.411575
PCORR                  0.58
SFCF                      1
CWH                0.000117
AG                 0.549305
CFR                    0.15
hydro_year               10
pfilter                   0
TT_rain            -0.68448
CFMAX_ice          4.228799
dtype: object
*-------------------*
Reading data
Set up period from 1998-01-01 to 1999-12-31 to set initial values
Simulation period from 2000-01-01 to 2020-12-31
Input data preprocessing successful
---
Initiating MATILDA simulation
Recalculating initial elevations based on glacier profile
&gt;&gt; Prior glacier elevation: 4001.8798828125m a.s.l.
&gt;&gt; Recalculated glacier elevation: 3951m a.s.l.
&gt;&gt; Prior non-glacierized elevation: 3185m a.s.l.
&gt;&gt; Recalculated non-glacierized elevation: 3191m a.s.l.
Calculating glacier evolution
*-------------------*
Running HBV routine
Finished spin up for initial HBV parameters
Finished HBV routine
*-------------------*
** Model efficiency based on Monthly aggregates **
KGE coefficient: 0.9
NSE coefficient: 0.83
RMSE: 20.51
MARE coefficient: 0.25
*-------------------*
       avg_temp_catchment  avg_temp_glaciers  evap_off_glaciers  \
count            6086.000           6086.000           6086.000   
mean               -3.356             -7.917              0.742   
std                 9.208              9.208              0.866   
min               -25.241            -29.802              0.000   
25%               -11.542            -16.100              0.000   
50%                -2.682             -7.241              0.248   
75%                 5.177              0.614              1.533   
max                13.809              9.248              3.086   
sum            -20425.581         -48180.457           4515.745   

       prec_off_glaciers  prec_on_glaciers  rain_off_glaciers  \
count           6086.000          6086.000           6086.000   
mean               1.936             0.304              1.356   
std                2.945             0.300              2.842   
min                0.000             0.000              0.000   
25%                0.000             0.106              0.000   
50%                0.720             0.186              0.000   
75%                2.686             0.382              1.492   
max               31.260             3.291             31.260   
sum            11781.847          1847.225           8250.310   

       snow_off_glaciers  rain_on_glaciers  snow_on_glaciers  \
count           6086.000          6086.000          6086.000   
mean               0.580             0.136             0.168   
std                1.450             0.295             0.214   
min                0.000             0.000             0.000   
25%                0.000             0.000             0.000   
50%                0.000             0.000             0.101   
75%                0.301             0.146             0.210   
max               15.523             3.291             1.909   
sum             3531.537           827.775          1019.450   

       snowpack_off_glaciers  ...  total_refreezing       SMB  \
count               6086.000  ...          6086.000  6086.000   
mean                  66.097  ...             0.026    -1.275   
std                   66.662  ...             0.066     7.198   
min                    0.000  ...             0.000   -36.014   
25%                    0.000  ...             0.000    -1.891   
50%                   55.681  ...             0.000     1.004   
75%                  119.747  ...             0.009     2.113   
max                  304.568  ...             0.480    18.789   
sum               402268.482  ...           156.619 -7759.477   

       actual_evaporation  total_precipitation  total_melt  \
count            6086.000             6086.000    6086.000   
mean                0.520                2.239       0.920   
std                 0.597                3.244       2.560   
min                 0.000                0.000       0.000   
25%                 0.000                0.106       0.000   
50%                 0.178                0.906       0.000   
75%                 1.107                3.075       0.812   
max                 2.017               34.551      23.311   
sum              3162.073            13629.072    5599.216   

       runoff_without_glaciers  runoff_from_glaciers  runoff_ratio  \
count                 6086.000              6086.000      6086.000   
mean                     1.425                 0.431         4.727   
std                      0.985                 0.808         7.820   
min                      0.000                 0.000         0.000   
25%                      0.532                 0.000         0.467   
50%                      1.185                 0.000         1.508   
75%                      2.201                 0.516         5.333   
max                      4.653                 5.234        59.080   
sum                   8672.048              2624.381     28768.537   

       total_runoff  observed_runoff  
count      6086.000         6086.000  
mean          1.856            1.970  
std           1.595            1.690  
min           0.000            0.230  
25%           0.532            0.690  
50%           1.200            1.106  
75%           3.123            3.046  
max           8.175            8.822  
sum       11296.430        11988.054  

[9 rows x 28 columns]
End of the MATILDA simulation
---
</pre></div>
</div>
<img alt="_images/2975e8771c76613c9c60f8643e3f657797e24fc462f4b9cbdf843a085f1bbac4.png" src="_images/2975e8771c76613c9c60f8643e3f657797e24fc462f4b9cbdf843a085f1bbac4.png" />
<img alt="_images/046f290fd69dba8a8c9967091b8294e648eb3bc697a984a2396301a6b32de384.png" src="_images/046f290fd69dba8a8c9967091b8294e648eb3bc697a984a2396301a6b32de384.png" />
<img alt="_images/1f01f62488d2021f756862a71c18115bd26bd9f3bc8fbcf67d485f4b15d78466.png" src="_images/1f01f62488d2021f756862a71c18115bd26bd9f3bc8fbcf67d485f4b15d78466.png" />
</div>
</div>
<p>In addition to the standard plots we can explore the results interactive <code class="docutils literal notranslate"><span class="pre">ploty</span></code> plots. Go ahead and zoom as you like or select/deselect individual curves.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_matilda</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
</div>
</div>
<p>The same works for the long-term seasonal cycle.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_matilda</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
</div>
</div>
</section>
<section id="sensitivity-analysis-with-fast">
<h2>Sensitivity Analysis with FAST<a class="headerlink" href="#sensitivity-analysis-with-fast" title="Link to this heading">#</a></h2>
<p>To reduce the computation time of the calibration procedure, we need to reduce the number of parameters to be optimized. Therefore, we will perform a global sensitivity analysis to identify the most important parameters and set the others to default values. The algorithm of choice will be the <a class="reference external" href="https://www.tandfonline.com/doi/abs/10.1080/00401706.1999.10485594">Fourier Amplitude Sensitivity Test (FAST)</a> available through the <a class="reference external" href="https://github.com/thouska/spotpy/blob/master/src/spotpy/algorithms/fast.py">SPOTPY</a> library. As before, we will show the general procedure with a few iterations, but display results from extensive runs on a HPC. You can use the results as a guide for your parameter choices, but keep in mind that they are highly correlated with your catchment properties, such as elevation range and glacier coverage.</p>
<p>First, we calculate the required number of iterations using a formula from <a class="reference external" href="https://www.informs-sim.org/wsc12papers/includes/files/con308.pdf">Henkel et. al. 2012</a>. We choose the SPOTPY default frequency step of 2 and set the interference factor to a maximum of 4, since we assume a high intercorrelation of the model parameters. The total number of parameters in MATILDA is 21.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fast_iter</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">interf</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">freqst</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the number of parameter iterations needed for parameterization and sensitivity analysis using FAST.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : int</span>
<span class="sd">        The number of input parameters being analyzed.</span>
<span class="sd">    interf : int</span>
<span class="sd">        The interference factor, which determines the degree of correlation between the input parameters.</span>
<span class="sd">    freqst : int</span>
<span class="sd">        The frequency step, which specifies the size of the intervals between each frequency at which the Fourier transform is calculated.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        The total number of parameter iterations needed for FAST.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">interf</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">param</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">freqst</span><span class="p">))</span> <span class="o">*</span> <span class="n">param</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Needed number of iterations for FAST: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fast_iter</span><span class="p">(</span><span class="mi">21</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Needed number of iterations for FAST: 52437
</pre></div>
</div>
</div>
</div>
<p>That is a lot of iterations! Running this routine on a single core would take about two days, but can be sped up significantly with each additional core. The setup would look exactly like the parameter optimization before.</p>
<div class="alert alert-block alert-info">
<b>Note:</b> No matter what number of iterations you define, SPOTPY will run $N*k$ times, where $k$ is the number of model parameters. So even if we set rep=10, the algorithm will run at least 21 times.</div><div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matilda.mspot_glacier</span> <span class="kn">import</span> <span class="n">psample</span>

<span class="n">fast_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rep&#39;</span><span class="p">:</span> <span class="mi">52437</span><span class="p">,</span>                              <span class="c1"># Choose wisely before running</span>
                 <span class="s1">&#39;target_mb&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;fast&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="s1">&#39;fast_matilda_example&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;fast_example&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;dbformat&#39;</span><span class="p">:</span> <span class="s1">&#39;csv&#39;</span>
                      <span class="p">}</span>
<span class="n">psample_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fast_settings</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Settings for FAST:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">psample_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">psample_settings</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

<span class="c1"># fast_results = psample(df=era5, obs=obs, **psample_settings)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Settings for FAST:


area_cat: 300.6637184185051
area_glac: 31.829413146586116
ele_cat: 3271.895648388366
ele_dat: 3324.5555520312164
ele_glac: 4001.8798828125
elev_rescaling: True
freq: M
lat: 42.18511742495568
set_up_end: 1999-12-31
set_up_start: 1998-01-01
sim_end: 2020-12-31
sim_start: 2000-01-01
glacier_profile:      Elevation      Area          WE  EleZone  norm_elevation   delta_h
0         1970  0.000000      0.0000     1900        1.000000  1.003442
1         2000  0.000000      0.0000     2000        0.989324  0.945813
2         2100  0.000000      0.0000     2100        0.953737  0.774793
3         2200  0.000000      0.0000     2200        0.918149  0.632696
4         2300  0.000000      0.0000     2300        0.882562  0.515361
..         ...       ...         ...      ...             ...       ...
156       4730  0.000023  20721.3700     4700        0.017794 -0.000265
157       4740  0.000012  14450.2180     4700        0.014235 -0.000692
158       4750  0.000006  10551.4730     4700        0.010676 -0.001119
159       4760  0.000000      0.0000     4700        0.007117 -0.001546
160       4780  0.000002   6084.7456     4700        0.000000 -0.002400

[161 rows x 6 columns]
rep: 52437
glacier_only: False
obj_dir: maximize
target_mb: None
target_swe:             SWE_Mean
Date                
1999-10-01    0.0003
1999-10-02    0.0002
1999-10-03    0.0001
1999-10-04    0.0001
1999-10-05    0.0000
...              ...
2017-09-26    0.0020
2017-09-27    0.0021
2017-09-28    0.0020
2017-09-29    0.0022
2017-09-30    0.0023

[6575 rows x 1 columns]
swe_scaling: 0.928
dbformat: csv
output: output/
algorithm: fast
dbname: output/fast_example
parallel: False
</pre></div>
</div>
</div>
</div>
<p>We ran <em>FAST</em>s for the example catchment an an HPC with the full number of iterations required. The results are saved in <em>CSV</em> files. We can use the <code class="docutils literal notranslate"><span class="pre">spotpy.analyser</span></code> library to create easy-to-read data frames from the databases. The summary shows the first (<code class="docutils literal notranslate"><span class="pre">S1</span></code>) and the total order sensitivity index (<code class="docutils literal notranslate"><span class="pre">ST</span></code>) for each parameter. <code class="docutils literal notranslate"><span class="pre">S1</span></code> refers to the variance of the model output explained by the parameter, holding all other parameters constant. The <code class="docutils literal notranslate"><span class="pre">ST</span></code> takes into account the interaction of the parameters and is therefore a good measure of the impact of individual parameters on the model output.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tools.helpers</span> <span class="kn">import</span> <span class="n">get_si</span>

<span class="n">display</span><span class="p">(</span><span class="n">get_si</span><span class="p">(</span><span class="n">dir_input</span> <span class="o">+</span> <span class="s1">&#39;FAST/&#39;</span> <span class="o">+</span> <span class="s1">&#39;example_fast_nolim.csv&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>S1</th>
      <th>ST</th>
    </tr>
    <tr>
      <th>param</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>lr_temp</th>
      <td>0.001027</td>
      <td>0.028119</td>
    </tr>
    <tr>
      <th>lr_prec</th>
      <td>0.000068</td>
      <td>0.020323</td>
    </tr>
    <tr>
      <th>BETA</th>
      <td>0.000406</td>
      <td>0.044880</td>
    </tr>
    <tr>
      <th>CET</th>
      <td>0.000183</td>
      <td>0.061767</td>
    </tr>
    <tr>
      <th>FC</th>
      <td>0.000177</td>
      <td>0.070427</td>
    </tr>
    <tr>
      <th>K0</th>
      <td>0.000128</td>
      <td>0.056534</td>
    </tr>
    <tr>
      <th>K1</th>
      <td>0.000611</td>
      <td>0.096560</td>
    </tr>
    <tr>
      <th>K2</th>
      <td>0.000564</td>
      <td>0.073538</td>
    </tr>
    <tr>
      <th>LP</th>
      <td>0.000296</td>
      <td>0.087176</td>
    </tr>
    <tr>
      <th>MAXBAS</th>
      <td>0.000166</td>
      <td>0.045120</td>
    </tr>
    <tr>
      <th>PERC</th>
      <td>0.000079</td>
      <td>0.051002</td>
    </tr>
    <tr>
      <th>UZL</th>
      <td>0.000129</td>
      <td>0.056398</td>
    </tr>
    <tr>
      <th>PCORR</th>
      <td>0.011253</td>
      <td>0.857075</td>
    </tr>
    <tr>
      <th>TT_snow</th>
      <td>0.000339</td>
      <td>0.087251</td>
    </tr>
    <tr>
      <th>TT_diff</th>
      <td>0.000221</td>
      <td>0.064408</td>
    </tr>
    <tr>
      <th>CFMAX_ice</th>
      <td>0.001746</td>
      <td>0.121897</td>
    </tr>
    <tr>
      <th>CFMAX_rel</th>
      <td>0.000108</td>
      <td>0.083392</td>
    </tr>
    <tr>
      <th>SFCF</th>
      <td>0.007414</td>
      <td>0.137477</td>
    </tr>
    <tr>
      <th>CWH</th>
      <td>0.000612</td>
      <td>0.063503</td>
    </tr>
    <tr>
      <th>AG</th>
      <td>0.000275</td>
      <td>0.116503</td>
    </tr>
    <tr>
      <th>RFS</th>
      <td>0.000089</td>
      <td>0.098914</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>If you have additional information on certain parameters, limiting their bounds can have a large impact on sensitivity. For our example catchment, field observations showed that the temperature lapse rate and precipitation correction were unlikely to exceed a certain range, so we limited the parameter space for both and ran a <em>FAST</em> again.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lim_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lr_temp_lo&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.007</span><span class="p">,</span> <span class="s1">&#39;lr_temp_up&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="s1">&#39;PCORR_lo&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;PCORR_up&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">}</span>
<span class="c1"># fast_results = psample(df=era5, obs=obs, **psample_settings, **lim_dict)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>To see the effect of parameter restrictions on sensitivity, we can plot the indices of both runs. Feel free to explore further by adding more <em>FAST</em> outputs to the plot function.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tools.plots</span> <span class="kn">import</span> <span class="n">plot_sensitivity_bars</span>

<span class="n">step1</span> <span class="o">=</span> <span class="n">dir_input</span> <span class="o">+</span> <span class="s1">&#39;FAST/&#39;</span> <span class="o">+</span> <span class="s1">&#39;example_fast_nolim.csv&#39;</span>
<span class="n">step2</span> <span class="o">=</span> <span class="n">dir_input</span> <span class="o">+</span> <span class="s1">&#39;FAST/&#39;</span> <span class="o">+</span> <span class="s1">&#39;era5_ipynb_fast_step1.csv&#39;</span>

<span class="n">plot_sensitivity_bars</span><span class="p">(</span><span class="n">step1</span><span class="p">,</span> <span class="n">step2</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Limits&#39;</span><span class="p">,</span> <span class="s1">&#39;lr_temp and PCORR limited&#39;</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
</div>
</div>
<p>From this figure, we can easily identify the most important parameters. Depending on your desired accuracy and computational resources, you can choose a sensitivity threshold. Let’s say we want to fix all parameters with a sensitivity index below 0.1. For our example, this will reduce the calibration parameters to 7.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">si_df</span> <span class="o">=</span> <span class="n">get_si</span><span class="p">(</span><span class="n">step2</span><span class="p">)</span>
<span class="n">sensitive</span> <span class="o">=</span> <span class="n">si_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">si_df</span><span class="p">[</span><span class="s1">&#39;ST&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.10</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parameters with a sensitivity index &gt; 0.1:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sensitive</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Parameters with a sensitivity index &gt; 0.1:
K1
K2
LP
PCORR
TT_snow
CFMAX_ice
SFCF
</pre></div>
</div>
</div>
</div>
<p>To give you an idea how much this procedure can reduce calibration time, we run the <code class="docutils literal notranslate"><span class="pre">fast_iter()</span></code> function again.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Needed number of iterations for FAST with all parameters: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fast_iter</span><span class="p">(</span><span class="mi">21</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Needed number of iterations for FAST with the 7 most sensitive parameters: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fast_iter</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Needed number of iterations for FAST with all parameters: 52437
Needed number of iterations for FAST with the 7 most sensitive parameters: 4935
</pre></div>
</div>
</div>
</div>
<p>For a single core this would roughly translate into a reduction from 44h to 4h.</p>
<p>To run the calibration with the reduced parameter space, we simply need to define values for the fixed parameters and use a helper function to translate them into boundary arguments. Here we simply use the values from our last <em>SPOTPY</em> run (<code class="docutils literal notranslate"><span class="pre">param</span></code>).</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matilda.mspot_glacier</span> <span class="kn">import</span> <span class="n">dict2bounds</span>

<span class="n">fixed_param</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sensitive</span><span class="p">}</span>
<span class="n">fixed_param_bounds</span> <span class="o">=</span> <span class="n">dict2bounds</span><span class="p">(</span><span class="n">fixed_param</span><span class="p">)</span>
       
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fixed bounds:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fixed_param_bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fixed_param_bounds</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fixed bounds:

CFR_lo: 0.15
CET_lo: 0
lr_temp_lo: -0.006
lr_prec_lo: 0.0015
TT_diff_lo: 0.76198
CFMAX_snow_lo: 3.3677
BETA_lo: 1.0
FC_lo: 99.15976
K0_lo: 0.01
MAXBAS_lo: 2.0
PERC_lo: 0.09232826
UZL_lo: 126.411575
CFMAX_rel_lo: 1.2556936
CWH_lo: 0.000117
AG_lo: 0.54930484
CFR_up: 0.15
CET_up: 0
lr_temp_up: -0.006
lr_prec_up: 0.0015
TT_diff_up: 0.76198
CFMAX_snow_up: 3.3677
BETA_up: 1.0
FC_up: 99.15976
K0_up: 0.01
MAXBAS_up: 2.0
PERC_up: 0.09232826
UZL_up: 126.411575
CFMAX_rel_up: 1.2556936
CWH_up: 0.000117
AG_up: 0.54930484
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">psample()</span></code> setup is then as simple as before.</p>
<div class="cell tag_output_scroll tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rep&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>                             <span class="c1"># Number of model runs. For advice check the documentation of the algorithms.</span>
                <span class="s1">&#39;glacier_only&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>                 <span class="c1"># True when calibrating a entirely glacierized catchment</span>
                <span class="s1">&#39;obj_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;maximize&#39;</span><span class="p">,</span>                 <span class="c1"># should your objective funtion be maximized (e.g. NSE) or minimized (e.g. RMSE)</span>
                <span class="s1">&#39;target_mb&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">156</span><span class="p">,</span>                     <span class="c1"># Average annual glacier mass balance to target at</span>
                <span class="s1">&#39;dbformat&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                      <span class="c1"># Write the results to a file (&#39;csv&#39;, &#39;hdf5&#39;, &#39;ram&#39;, &#39;sql&#39;)</span>
                <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                        <span class="c1"># Choose where to store the files</span>
                <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;lhs&#39;</span><span class="p">,</span>                    <span class="c1"># Choose algorithm (for parallelization: mc, lhs, fast, rope, sceua or demcz)</span>
                <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="s1">&#39;era5_matilda_example&#39;</span><span class="p">,</span>      <span class="c1"># Choose name</span>
                       
                <span class="s1">&#39;parallel&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>                     <span class="c1"># Distribute the calculation on multiple cores or not</span>
                <span class="c1"># &#39;cores&#39;: 20                           # Set number of cores when running parallel</span>
                      <span class="p">}</span>
<span class="n">psample_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_settings</span><span class="p">)</span>

<span class="n">best_summary</span> <span class="o">=</span> <span class="n">psample</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">era5</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">psample_settings</span><span class="p">,</span> <span class="o">**</span><span class="n">fixed_param_bounds</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initializing the  Latin Hypercube Sampling (LHS)  with  10  repetitions
The objective function will be maximized
Starting the LHS algotrithm with 10 repetitions...
Creating LatinHyperCube Matrix
Initialize database...
[&#39;csv&#39;, &#39;hdf5&#39;, &#39;ram&#39;, &#39;sql&#39;, &#39;custom&#39;, &#39;noData&#39;]
2 of 10, maximal objective function=0.263245, time remaining: 00:00:06
4 of 10, maximal objective function=0.374722, time remaining: 00:00:05
6 of 10, maximal objective function=0.374722, time remaining: 00:00:03
8 of 10, maximal objective function=0.374722, time remaining: 00:00:01
10 of 10, maximal objective function=0.374722, time remaining: 23:59:59

*** Final SPOTPY summary ***
Total Duration: 12.81 seconds
Total Repetitions: 10
Maximal objective value: 0.374722
Corresponding parameter setting:
lr_temp: -0.006
lr_prec: 0.0015
BETA: 1
CET: 0
FC: 99.2
K0: 0.01
K1: 0.176607
K2: 0.0343977
LP: 0.925865
MAXBAS: 2
PERC: 0.0923
UZL: 126
PCORR: 0.628819
TT_snow: -1.19722
TT_diff: 0.762
CFMAX_snow: 3.37
CFMAX_rel: 1.26
SFCF: 0.801453
CWH: 0.000117
AG: 0.549
CFR: 0.15
******************************

WARNING: The selected algorithm lhs can either maximize or minimize the objective function. You can specify the direction by passing obj_dir to analyze_results(). The default is &#39;maximize&#39;.
Best parameter set:
lr_temp=-0.006, lr_prec=0.0015, BETA=1.0, CET=0.0, FC=99.2, K0=0.01, K1=0.17660737307393765, K2=0.03439772613695726, LP=0.9258651840128058, MAXBAS=2.0, PERC=0.0923, UZL=126.0, PCORR=0.6288190015669034, TT_snow=-1.1972232828572003, TT_diff=0.762, CFMAX_snow=3.37, CFMAX_rel=1.26, SFCF=0.8014532830182439, CWH=0.000117, AG=0.549, CFR=0.15
Run number 3 has the highest objectivefunction with: 0.3747
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<b>Note:</b> The number of iterations required depends on the selected algorithm and the number of free parameters. To choose the correct setting, consult the <a href='https://spotpy.readthedocs.io/en/latest/Algorithm_guide/'>SPOTPY documentation</a> and the original literature for each algorithm.</div><p>Now, we save the best parameter set for use in the next notebook. The set is stored in the <code class="docutils literal notranslate"><span class="pre">best_summary</span></code> variable.</p>
<p><strong>Note:</strong> In our example we will skip this step and use the <a class="reference internal" href="#param"><span class="xref myst">result from the calibration on an HPC cluster</span></a>.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># param = best_summary[&#39;best_param&#39;]</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Finally, we store the parameter set in a <code class="docutils literal notranslate"><span class="pre">.yml</span></code> file.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">write_yaml</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;parameters.yml&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter set stored in &#39;</span><span class="si">{</span><span class="n">dir_output</span><span class="si">}</span><span class="s2">parameters.yml&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data successfully written to YAML at output/parameters.yml
Parameter set stored in &#39;output/parameters.yml&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">shutil</span>

<span class="k">if</span> <span class="n">zip_output</span><span class="p">:</span>
    <span class="c1"># refresh `output_download.zip` with data retrieved within this notebook</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">make_archive</span><span class="p">(</span><span class="s1">&#39;output_download&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output folder can be download now (file output_download.zip)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Output folder can be download now (file output_download.zip)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">reset</span> -f
</pre></div>
</div>
</div>
</details>
</div>
<p>With this calibrated parameter set, you can now continue with <a class="reference internal" href="Notebook5_MATILDA_scenarios.html"><span class="std std-doc">Notebook 5</span></a> to run the calibrated model for the whole ensemble.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Notebook3_CMIP6.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Climate scenario data</p>
      </div>
    </a>
    <a class="right-next"
       href="Notebook5_MATILDA_scenarios.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">MATILDA Scenarios</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-matilda-with-default-parameters">Run MATILDA with default parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrate-matilda">Calibrate MATILDA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#glacier-surface-mass-balance-data">Glacier surface mass balance data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#snow-water-equivalent">Snow water equivalent</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-based-calibration">Process-based calibration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-input-correction">Step 1: Input correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-snow-routine-calibration">Step 2: Snow routine calibration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-glacier-routine-calibration">Step 3: Glacier routine calibration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-soil-and-routing-routine-calibration">Step 4: Soil and routing routine calibration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-matilda-with-calibrated-parameters">Run MATILDA with calibrated parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sensitivity-analysis-with-fast">Sensitivity Analysis with FAST</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Phillip Schuster
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>