

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Climate forcing data &#8212; MATILDA-##</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Notebook2_Forcing_data';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Climate scenario data" href="Notebook3_CMIP6.html" />
    <link rel="prev" title="Catchment delineation" href="Notebook1_Catchment_delineation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="Notebook0_Introduction.html">
  
  
  
  
    
    
      
    
    
    <img src="https://www.hu-berlin.de/++resource++humboldt.logo.Logo.svg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="https://www.hu-berlin.de/++resource++humboldt.logo.Logo.svg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="Notebook0_Introduction.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Notebook1_Catchment_delineation.html">Catchment delineation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Climate forcing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook3_CMIP6.html">Climate scenario data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook4_MATILDA.html">Calibrating the MATILDA framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook5_MATILDA_scenarios.html">MATILDA Scenarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook6_Analysis.html">Model Output Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook7_Climate_Change_Impact.html">Climate Change Impact Analysis</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/phiscu/matilda_edu/no_output?urlpath=lab/tree/Notebook2_Forcing_data.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/phiscu/matilda_edu" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/phiscu/matilda_edu/issues/new?title=Issue%20on%20page%20%2FNotebook2_Forcing_data.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Notebook2_Forcing_data.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Climate forcing data</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-the-date-range">Set the date range</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#era5l-geopotential-height">ERA5L Geopotential height</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#era5-land-temperature-and-precipitation-data">ERA5-Land Temperature and Precipitation Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#store-data-for-next-steps">Store data for next steps</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="climate-forcing-data">
<h1>Climate forcing data<a class="headerlink" href="#climate-forcing-data" title="Permalink to this heading">#</a></h1>
<p>Now that we have all the static data, we can focus on the <strong>climate variables</strong>. In this notebook we will…</p>
<ol class="arabic simple">
<li><p>…download <strong>ERA5 land reanalysis data</strong> aggregated to our catchment area,</p></li>
<li><p>…and determine the <strong>reference altitude</strong> of the data from the geopotential height.</p></li>
</ol>
<p>For data preprocessing and download we will again use the <strong>Google Earth Engine</strong> (GEE) to offload as much as possible to external servers. ERA5-Land is the latest reanalysis dataset from the European Center for Medium-Range Weather Forecast (<a class="reference external" href="https://www.ecmwf.int/en/era5-land">ECMWF</a>), available from 1950 to near real-time. The GEE data catalog summarizes…</p>
<blockquote>
<div><p>ERA5-Land is a reanalysis dataset providing a consistent view of the evolution of land variables over several decades at an enhanced resolution compared to ERA5. ERA5-Land has been produced by replaying the land component of the ECMWF ERA5 climate reanalysis. Reanalysis combines model data with observations from across the world into a globally complete and consistent dataset using the laws of physics. Reanalysis produces data that goes several decades back in time, providing an accurate description of the climate of the past.</p>
<p>Source: <a class="reference external" href="https://developers.google.com/earth-engine/datasets/catalog/ECMWF_ERA5_LAND_DAILY_RAW#description">GEE Data Catalog</a></p>
</div></blockquote>
<p>To get started we <strong>initialize</strong> the GEE API again…</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ee</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">ee</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">ee</span><span class="o">.</span><span class="n">Authenticate</span><span class="p">()</span>         <span class="c1"># authenticate when using GEE for the first time</span>
    <span class="n">ee</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>…and read some settings from the <code class="docutils literal notranslate"><span class="pre">config.ini</span></code> file:</p>
<ul class="simple">
<li><p><strong>input/output folders</strong> for data imports and downloads</p></li>
<li><p><strong>filenames</strong> (DEM, GeoPackage)</p></li>
<li><p>include future <strong>projections</strong> or not</p></li>
<li><p>show/hide <strong>interactive map</strong> in notebooks</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">ast</span>

<span class="c1"># read local config.ini file</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;config.ini&#39;</span><span class="p">)</span>

<span class="c1"># get file config from config.ini</span>
<span class="n">dir_input</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FILE_SETTINGS&#39;</span><span class="p">][</span><span class="s1">&#39;DIR_INPUT&#39;</span><span class="p">]</span>
<span class="n">dir_output</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FILE_SETTINGS&#39;</span><span class="p">][</span><span class="s1">&#39;DIR_OUTPUT&#39;</span><span class="p">]</span>
<span class="n">output_gpkg</span> <span class="o">=</span> <span class="n">dir_output</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FILE_SETTINGS&#39;</span><span class="p">][</span><span class="s1">&#39;GPKG_NAME&#39;</span><span class="p">]</span>
<span class="n">scenarios</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;CONFIG&#39;</span><span class="p">,</span> <span class="s1">&#39;PROJECTIONS&#39;</span><span class="p">)</span>
<span class="n">show_map</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;CONFIG&#39;</span><span class="p">,</span><span class="s1">&#39;SHOW_MAP&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>We can now load the catchment outline from the previous notebook and convert it to a <code class="docutils literal notranslate"><span class="pre">ee.FeatureCollection</span></code> to use it in GEE.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">geemap</span>

<span class="n">catchment_new</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">output_gpkg</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;catchment_new&#39;</span><span class="p">)</span>
<span class="n">catchment</span> <span class="o">=</span> <span class="n">geemap</span><span class="o">.</span><span class="n">geopandas_to_ee</span><span class="p">(</span><span class="n">catchment_new</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="set-the-date-range">
<h2>Set the date range<a class="headerlink" href="#set-the-date-range" title="Permalink to this heading">#</a></h2>
<p>If you are only interested in modeling the past, set <code class="docutils literal notranslate"><span class="pre">PROJECTIONS=False</span></code> in the <code class="docutils literal notranslate"><span class="pre">config.ini</span></code> to only download reanalysis data for your defined modeling period. Otherwise, all available historical data (since 1979) is downloaded to provide the best possible basis for bias adjustment of the climate scenario data.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">scenarios</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">date_range</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1979-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-01-01&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">date_range</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;CONFIG&#39;</span><span class="p">][</span><span class="s1">&#39;DATE_RANGE&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The selected date range is </span><span class="si">{</span><span class="n">date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">date_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The selected date range is 1979-01-01 to 2023-01-01
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="era5l-geopotential-height">
<h2>ERA5L Geopotential height<a class="headerlink" href="#era5l-geopotential-height" title="Permalink to this heading">#</a></h2>
<p>The <strong>reference surface elevation</strong> of ERA5-Land grid cells cannot be obtained directly, but must be calculated from the <strong>geopotential</strong>.</p>
<blockquote>
<div><p>This parameter is the gravitational potential energy of a unit mass, at a particular location, relative to mean sea level. It is also the amount of work that would have to be done, against the force of gravity, to lift a unit mass to that location from mean sea level.</p>
<p>The geopotential height can be calculated by dividing the geopotential by the Earth’s gravitational acceleration, g (=9.80665 m s-2). The geopotential height plays an important role in synoptic meteorology (analysis of weather patterns). Charts of geopotential height plotted at constant pressure levels (e.g., 300, 500 or 850 hPa) can be used to identify weather systems such as cyclones, anticyclones, troughs and ridges.</p>
<p>At the surface of the Earth, this parameter shows the variations in geopotential (height) of the surface, and is often referred to as the orography.</p>
<p>Source: <a class="reference external" href="https://codes.ecmwf.int/grib/param-db/?id=129">ECMWF Parameter Database</a></p>
</div></blockquote>
<p>Since the ERA5 geopotential height is not available in the GEE Data Catalog, we downloaded it using the ECMWF Copernicus Data Store (<a class="reference external" href="https://cds.climate.copernicus.eu/#!/home">CDS</a>) API, converted it to <code class="docutils literal notranslate"><span class="pre">.ncdf</span></code> format, and reuploaded it. Therefore, the file has to be accessed in a similar way to the ice thickness data in Notebook 1.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">resourcespace</span> <span class="kn">import</span> <span class="n">ResourceSpace</span>

<span class="c1"># use guest credentials to access media server </span>
<span class="n">api_base_url</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;MEDIA_SERVER&#39;</span><span class="p">][</span><span class="s1">&#39;api_base_url&#39;</span><span class="p">]</span>
<span class="n">private_key</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;MEDIA_SERVER&#39;</span><span class="p">][</span><span class="s1">&#39;private_key&#39;</span><span class="p">]</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;MEDIA_SERVER&#39;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>

<span class="n">myrepository</span> <span class="o">=</span> <span class="n">ResourceSpace</span><span class="p">(</span><span class="n">api_base_url</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">private_key</span><span class="p">)</span>

<span class="c1"># get resource IDs for each .zip file</span>
<span class="n">refs_era5l</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">myrepository</span><span class="o">.</span><span class="n">get_collection_resources</span><span class="p">(</span><span class="mi">128</span><span class="p">))[[</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="s1">&#39;file_size&#39;</span><span class="p">,</span> <span class="s1">&#39;file_extension&#39;</span><span class="p">,</span> <span class="s1">&#39;field8&#39;</span><span class="p">]]</span>
<span class="n">ref_geopot</span> <span class="o">=</span> <span class="n">refs_era5l</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">refs_era5l</span><span class="p">[</span><span class="s1">&#39;field8&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ERA5_land_Z_geopotential&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataset file and reference on media server:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">ref_geopot</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset file and reference on media server:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ref</th>
      <th>file_size</th>
      <th>file_extension</th>
      <th>field8</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>27215</td>
      <td>8062521</td>
      <td>zip</td>
      <td>ERA5_land_Z_geopotential</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.ncdf</span></code> file is then unzipped and loaded as <code class="docutils literal notranslate"><span class="pre">xarray</span></code> dataset for further processing.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="n">content</span> <span class="o">=</span> <span class="n">myrepository</span><span class="o">.</span><span class="n">get_resource_file</span><span class="p">(</span><span class="n">ref_geopot</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;ref&#39;</span><span class="p">])</span>
<span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipObj</span><span class="p">:</span>
    <span class="c1"># Get a list of all archived file names from the zip</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">zipObj</span><span class="o">.</span><span class="n">namelist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading file &quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;...&#39;</span><span class="p">)</span>
    <span class="n">file_bytes</span> <span class="o">=</span> <span class="n">zipObj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="c1"># Open the file-like object as an xarray dataset</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_bytes</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dataset contains </span><span class="si">{</span><span class="n">ds</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">ds</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> as variable </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">ds</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;GRIB_cfVarName&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reading file &quot;ERA5_land_Z_geopotential.nc&quot;...
Dataset contains Geopotential in m**2 s**-2 as variable &#39;z&#39;
</pre></div>
</div>
</div>
</div>
<p>The original dataset covers the entire globe, so we crop it to the catchment area plus a 1° buffer zone.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get catchment bounding box with buffer</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="n">catchment_new</span><span class="o">.</span><span class="n">total_bounds</span>
<span class="n">min_lon</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">min_lat</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">max_lon</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">max_lat</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">cropped_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">min_lat</span><span class="p">,</span><span class="n">max_lat</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">min_lon</span><span class="p">,</span><span class="n">max_lon</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;xr.Dataset cropped to bbox[</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">min_lon</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">min_lat</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">max_lon</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">max_lat</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>xr.Dataset cropped to bbox[77.06, 41.05, 79.33, 43]
</pre></div>
</div>
</div>
</div>
<p>To load <code class="docutils literal notranslate"><span class="pre">xarray</span></code> data into GEE a little workaround is needed. Credits go out to <a class="reference external" href="https://github.com/lopezvoliver/geemap/blob/netcdf_to_ee/geemap/common.py#L1776">Oliver Lopez</a> for this solution.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># function to load nc file into GEE</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">netcdf_to_ee</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>

    <span class="n">lon_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">lat_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">dim_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">lon_data</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">dim_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">lat_data</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dim_lon</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dim_lat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The netCDF file is not a regular longitude/latitude grid&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting xarray to numpy array...&quot;</span><span class="p">)</span>
    <span class="n">data_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data_np</span><span class="p">)</span>

    <span class="c1"># Figure out if we need to roll the data or not</span>
    <span class="c1"># (see https://github.com/giswqs/geemap/issues/285#issuecomment-791385176)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lon_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
        <span class="n">data_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">data_np</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">west_lon</span> <span class="o">=</span> <span class="n">lon_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">180</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">west_lon</span> <span class="o">=</span> <span class="n">lon_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving data extent and origin...&quot;</span><span class="p">)</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="p">[</span><span class="n">dim_lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">west_lon</span><span class="p">)</span> <span class="o">-</span> <span class="n">dim_lon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dim_lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">lat_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">dim_lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting numpy array to ee.Array...&quot;</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">geemap</span><span class="o">.</span><span class="n">numpy_to_ee</span><span class="p">(</span>
        <span class="n">data_np</span><span class="p">,</span> <span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">band_names</span><span class="o">=</span><span class="s1">&#39;z&#39;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">data_np</span><span class="p">,</span> <span class="n">transform</span>


<span class="n">image</span><span class="p">,</span> <span class="n">data_np</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">netcdf_to_ee</span><span class="p">(</span><span class="n">cropped_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Converting xarray to numpy array...
Saving data extent and origin...
Converting numpy array to ee.Array...
Done!
</pre></div>
</div>
</div>
</div>
<p>If mapping is enabled in the <code class="docutils literal notranslate"><span class="pre">config.ini</span></code> you can now display the <strong>geopotential</strong> data in the <strong>GEE map</strong>. <a id="map"></a></p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geemap.colormaps</span> <span class="k">as</span> <span class="nn">cm</span>

<span class="k">if</span> <span class="n">show_map</span><span class="p">:</span>
    <span class="n">Map</span> <span class="o">=</span> <span class="n">geemap</span><span class="o">.</span><span class="n">Map</span><span class="p">()</span>
    <span class="c1"># add geopotential as layer</span>
    <span class="n">vis_params</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_np</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_np</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="s1">&#39;palette&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">palettes</span><span class="o">.</span><span class="n">terrain</span><span class="p">,</span> <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">}</span>
    <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">vis_params</span><span class="p">,</span> <span class="s2">&quot;ERA5L geopotential&quot;</span><span class="p">)</span>
    
    <span class="c1"># add catchment</span>
    <span class="n">Map</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span><span class="n">catchment</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;darkgrey&#39;</span><span class="p">},</span> <span class="s2">&quot;Catchment&quot;</span><span class="p">)</span>
    <span class="n">Map</span><span class="o">.</span><span class="n">centerObject</span><span class="p">(</span><span class="n">catchment</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">Map</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Map view disabled in config.ini&quot;</span><span class="p">)</span>        
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "836f4fd9dcd241a89bf46535015cd0eb", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Since our workflow will use a <strong>lumped model</strong>, we will use <strong>area-weighted catchment-wide averages</strong> of our forcing data. Thus, we also aggregate the geopotential based on the grid cell fractions in the catchment and convert it to <strong>geopotential height in meters above sea level</strong>. This represents the <strong>reference altitude of our forcing data</strong>, just as the elevation of a weather station would.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># execute reducer</span>
<span class="nb">dict</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                          <span class="n">geometry</span><span class="o">=</span><span class="n">catchment</span><span class="p">,</span>
                          <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span>
                          <span class="n">crsTransform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>

<span class="c1"># get mean value and print</span>
<span class="n">mean_val</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
<span class="n">ele_dat</span> <span class="o">=</span> <span class="n">mean_val</span> <span class="o">/</span> <span class="mf">9.80665</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Geopotential mean:</span><span class="se">\t</span><span class="si">{</span><span class="n">mean_val</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> m2 s-2</span><span class="se">\n</span><span class="s1">Elevation:</span><span class="se">\t\t</span><span class="s1"> </span><span class="si">{</span><span class="n">ele_dat</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> m a.s.l.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Geopotential mean:	32711.74 m2 s-2
Elevation:		 3335.67 m a.s.l.
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="era5-land-temperature-and-precipitation-data">
<h2>ERA5-Land Temperature and Precipitation Data<a class="headerlink" href="#era5-land-temperature-and-precipitation-data" title="Permalink to this heading">#</a></h2>
<p>Our model only requires <strong>temperature and precipitation</strong> as inputs. We will download both time series from the <strong>ERA5-Land Daily Aggregated - ECMWF Climate Reanalysis</strong> <code class="docutils literal notranslate"><span class="pre">ECMWF/ERA5_LAND/DAILY_RAW</span></code> dataset in the <a href="https://developers.google.com/earth-engine/datasets/catalog/ECMWF_ERA5_LAND_DAILY_RAW#bands">Google Earth Engine Data Catalog</a></p>
<blockquote>
<div><p>The asset is a daily aggregate of ECMWF ERA5 Land hourly assets. […] Daily aggregates have been pre-calculated to facilitate many applications requiring easy and fast access to the data.</p>
<p>Source: <a class="reference external" href="https://developers.google.com/earth-engine/datasets/catalog/ECMWF_ERA5_LAND_DAILY_RAW#description">GEE Data Catalog</a></p>
</div></blockquote>
<p>On the server side, we simply create an <code class="docutils literal notranslate"><span class="pre">ee.ImageCollection</span></code> with the desired bands (temperature and precipitation) and date range. To calculate area-weighted aggregates we apply the <code class="docutils literal notranslate"><span class="pre">ee.Reducer</span></code> function.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="k">def</span> <span class="nf">setProperty</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="nb">dict</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">catchment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>


<span class="n">collection</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s1">&#39;ECMWF/ERA5_LAND/DAILY_RAW&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;temperature_2m&#39;</span><span class="p">,</span><span class="s1">&#39;total_precipitation_sum&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">date_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">withMean</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">setProperty</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>We can then aggregate the results into arrays, download them with <code class="docutils literal notranslate"><span class="pre">.getInfo()</span></code> and store them as dataframe columns. Depending on the selected date range and server traffic this can take up to a few minutes.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Get timestamps...&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">withMean</span><span class="o">.</span><span class="n">aggregate_array</span><span class="p">(</span><span class="s1">&#39;system:time_start&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Get temperature values...&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">withMean</span><span class="o">.</span><span class="n">aggregate_array</span><span class="p">(</span><span class="s1">&#39;temperature_2m&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;temp_c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Get precipitation values...&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;prec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">withMean</span><span class="o">.</span><span class="n">aggregate_array</span><span class="p">(</span><span class="s1">&#39;total_precipitation_sum&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;prec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prec&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Get timestamps...
Get temperature values...
Get precipitation values...
CPU times: user 503 ms, sys: 12.3 ms, total: 515 ms
Wall time: 1min 48s
</pre></div>
</div>
</div>
</div>
<p>The constructed data frame now looks like this:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ts</th>
      <th>dt</th>
      <th>temp</th>
      <th>temp_c</th>
      <th>prec</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>283996800000</td>
      <td>1979-01-01 01:00:00</td>
      <td>257.392996</td>
      <td>-15.757004</td>
      <td>0.023400</td>
    </tr>
    <tr>
      <th>1</th>
      <td>284083200000</td>
      <td>1979-01-02 01:00:00</td>
      <td>256.435964</td>
      <td>-16.714036</td>
      <td>0.004129</td>
    </tr>
    <tr>
      <th>2</th>
      <td>284169600000</td>
      <td>1979-01-03 01:00:00</td>
      <td>257.867342</td>
      <td>-15.282658</td>
      <td>0.001601</td>
    </tr>
    <tr>
      <th>3</th>
      <td>284256000000</td>
      <td>1979-01-04 01:00:00</td>
      <td>258.322419</td>
      <td>-14.827581</td>
      <td>0.334886</td>
    </tr>
    <tr>
      <th>4</th>
      <td>284342400000</td>
      <td>1979-01-05 01:00:00</td>
      <td>258.056697</td>
      <td>-15.093303</td>
      <td>0.057215</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>16066</th>
      <td>1672099200000</td>
      <td>2022-12-27 01:00:00</td>
      <td>253.990888</td>
      <td>-19.159112</td>
      <td>0.001670</td>
    </tr>
    <tr>
      <th>16067</th>
      <td>1672185600000</td>
      <td>2022-12-28 01:00:00</td>
      <td>257.364969</td>
      <td>-15.785031</td>
      <td>0.223425</td>
    </tr>
    <tr>
      <th>16068</th>
      <td>1672272000000</td>
      <td>2022-12-29 01:00:00</td>
      <td>255.975972</td>
      <td>-17.174028</td>
      <td>1.357699</td>
    </tr>
    <tr>
      <th>16069</th>
      <td>1672358400000</td>
      <td>2022-12-30 01:00:00</td>
      <td>256.748078</td>
      <td>-16.401922</td>
      <td>3.906910</td>
    </tr>
    <tr>
      <th>16070</th>
      <td>1672444800000</td>
      <td>2022-12-31 01:00:00</td>
      <td>255.077631</td>
      <td>-18.072369</td>
      <td>1.239511</td>
    </tr>
  </tbody>
</table>
<p>16071 rows × 5 columns</p>
</div></div></div>
</div>
<p>Let’s <strong>plot</strong> the full time series.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>

<span class="n">axes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;ts&#39;</span><span class="p">,</span><span class="s1">&#39;temp&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
                                               <span class="n">title</span><span class="o">=</span><span class="s1">&#39;ERA5-Land Data for Target Catchment&#39;</span><span class="p">,</span>
                                               <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;prec&quot;</span><span class="p">:</span> <span class="s2">&quot;darkblue&quot;</span><span class="p">})</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Temperature [°C]&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Precipitation [mm]&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">YearLocator</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">date_range</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/50dfd86de8e6e0eafc797944b0e913da7eee821509508fd4fd1e8e9230229113.png" src="_images/50dfd86de8e6e0eafc797944b0e913da7eee821509508fd4fd1e8e9230229113.png" />
</div>
</div>
</section>
<section id="store-data-for-next-steps">
<h2>Store data for next steps<a class="headerlink" href="#store-data-for-next-steps" title="Permalink to this heading">#</a></h2>
<p>To continue in the workflow, we write the ERA5 data to a <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file…</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;ERA5L.csv&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>…and update the <code class="docutils literal notranslate"><span class="pre">settings.yml</span></code> file with the reference altitude of the ERA5-Land data (<code class="docutils literal notranslate"><span class="pre">ele_dat</span></code>).</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tools.helpers</span> <span class="kn">import</span> <span class="n">update_yaml</span>
        
<span class="n">update_yaml</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;settings.yml&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ele_dat&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ele_dat</span><span class="p">)})</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">reset</span> -f
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="Notebook1_Catchment_delineation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Catchment delineation</p>
      </div>
    </a>
    <a class="right-next"
       href="Notebook3_CMIP6.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Climate scenario data</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-the-date-range">Set the date range</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#era5l-geopotential-height">ERA5L Geopotential height</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#era5-land-temperature-and-precipitation-data">ERA5-Land Temperature and Precipitation Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#store-data-for-next-steps">Store data for next steps</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Phillip Schuster-###
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023-xx.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>